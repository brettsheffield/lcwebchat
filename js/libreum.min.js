!function(r,u){"use strict";var o,a,t=13,i=40,s=38,c=32,p=1,d=2,f=3,l=5e3,h=["sysmsg"],v=[],m=[],g="",y=[],E=-1,k=localStorage,_="guest";function n(){var e=this;this.channels=[],this.socket=new LIBRECAST.Socket(a,J);for(var t=[this.socket.defer],n=0;n<arguments.length;n++){var i;try{(i=new LIBRECAST.Channel(a,arguments[n],w)).chatPane=this}catch(e){continue}this.channels.push(i),t.push(i.defer)}var s=this.socket;this.channels.forEach(function(e){r.when(s.defer,e.defer).done(function(){e.bindSocket(s,C),e.interval=setInterval(e.ping.bind(e),l)})}),r.when.apply(r,t).done(function(){e.onReady()})}function L(e){this.nick=e}function T(e){this.nick=_,this.text=e}u.FILTER_KEY="k",u.FILTER_KEY_LONG="key",u.FILTER_NICK="n",u.FILTER_NICK_LONG="nick",u.FILTER_TIME="t",u.FILTER_TIME_LONG="time",u.FILTER_SHORT=[u.FILTER_KEY,u.FILTER_NICK,u.FILTER_TIME],u.FILTER_LONG=[u.FILTER_KEY_LONG,u.FILTER_NICK_LONG,u.FILTER_TIME_LONG],n.prototype.onReady=function(){},L.prototype.seen=function(e){return this.lastSeen=void 0===e?new Date:new Date(e),this},LIBRECAST.Channel.prototype.ping=function(){this.setval("join",_)},LIBRECAST.Channel.prototype.sysmsg=function(e){void 0!==e.html&&this.write(e.html)},LIBRECAST.Channel.prototype.userJoin=function(e){var t=this.id2;return void 0===this.userStatus(e)&&(this.users[e]=new L(e),V(e+" has joined "+this.name,t)),this.users[e].seen(),this},LIBRECAST.Channel.prototype.userPart=function(e){var t=this.id2;void 0===this.userStatus(e)&&(this.users[e]=new L(e),V(e+" has left "+this.name,t)),this.users[e].seen()},LIBRECAST.Channel.prototype.userStatus=function(e,t){return void 0===this.users&&(this.users=[]),void 0===t?this.users[e]:(this.users[e]=new L(e).seen(),this)},LIBRECAST.Channel.prototype.write=function(e){W(e,this.id2)},LIBRECAST.Filter=function(e){this.arg=e;var t=["<",">","="];for(var n in t)for(var i=0;i<e.length;i++)if(e[i]===t[n]){for(var s in this.type=e.substring(0,i),"="===e[i+1]?(this.op=t[n]+"=",this.key=e.substring(i+2)):(this.op=t[n],this.key=e.substring(i+1)),u.FILTER_LONG)this.type===u.FILTER_LONG[s]&&(this.type=u.FILTER_SHORT[s]);if(this.type===u.FILTER_TIME){var a=moment(this.key);a.isValid()&&(this.key=a.format("x")+"000000")}return this}return this.type=u.FILTER_KEY,this.op="=",this.key=e,this},LIBRECAST.Query.prototype.filter=function(e){var t=new LIBRECAST.Filter(e);if(t.type===u.FILTER_KEY)this.key("message_keyword",t.key.toLowerCase().replace(/\W+/g,""));else if(t.type===u.FILTER_NICK)this.key("message_nick",t.key.toLowerCase().replace(/\W+/g,""));else if(t.type===u.FILTER_TIME){var n;for(var i in t.op)"<"===t.op[i]?n|=u.QUERY_LT:">"===t.op[i]?n|=u.QUERY_GT:"="===t.op[i]&&(n|=u.QUERY_EQ);void 0===n&&(n=u.QUERY_EQ),this.timestamp(t.key,n)}else this.filter(e.substring(1));return this},T.prototype.format=function(){return"<"+this.nick+"> "+this.text},T.prototype.parse=function(e){var t=JSON.parse(e);for(var n in t)this[n]=t[n];return this},T.prototype.type=function(e){return void 0===e?this.type:(this.type=e,this)};var C=function(){var e,t=this;for(var n in m)if(m[n].name===t.name){e=m[n].timestamp;break}m[t.id2]=t,k.activeChannel!=t.name&&void 0!==o||N(t.id2),function(e){var t=r("li:contains("+e.name+")"),n=e.id2;if(t.length){var i=t.attr("id").split("_")[1];r("li#chansock_"+i).attr("id","chansock_"+n),r("div#socket_"+i).attr("id","socket_"+n),r("div#topic_"+i).attr("id","topic_"+n)}else{var s=r("div.chat");s.append('<div id="topic_'+n+'" class="topic"></div>'),s.append('<div id="socket_'+n+'" class="socket"></div>'),t=r('<li id="chansock_'+n+'">'+e.name+"</li>"),r("div.channels").append(t),t.on("click",function(){var e=r(this).attr("id").split("_")[1];N(e)})}k.activeChannel==e.name&&N(n)}(t),M(t.name,t.id2),t.getval("topic",B);var i=(new LIBRECAST.Query).timestamp(e,u.QUERY_GT);t.getmsg(A,i)},w=function(e){var t=e.obj;t.join(K),-1===v.indexOf(t.name)&&(v.push(t.name),k.channels=JSON.stringify(v))};function I(e){var t=e[1];return void 0===t&&(t=Q(_)),o&&_&&o.send("/sysmsg "+_+" is now known as "+t),_=t,void 0!==k&&(k.nick=_),!0}function R(e){var t;if(void 0!==e[1]){if(!(t=H(e[1])))return!0}else t=o.name;return V('parting channel "'+t+'"'),-1===v.indexOf(t)||function(e){var t=D(e),n=m[t],i=(new T).type(d);n.send(JSON.stringify(i)),function(e){for(var t=0,n=v.length;t<n;t++)if(v[t]===e.toLowerCase()){v.splice(v.indexOf(t)),k.channels=JSON.stringify(v);break}}(e),k.activeChannel===e&&N(D(v[0]));r("#socket_"+t).remove(),r("#chansock_"+t).remove()}(t),!0}function S(e){var t=H(([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)}));return x(t),k.activeChannel=t,!0}function b(){return r("#usercmd").val()}function O(e){r("#usercmd").val(e)}function F(e){if(e>y.length)e=y.length;else{if(e<0)return O(g),void(E=-1);0==e&&-1==E&&(g=b())}void 0!==y[e]&&(O(y[e]),E=e)}function N(e){var t=r("div.chat");t.find("div.topic").removeClass("active"),t.find("div.socket").removeClass("active"),r("div.channels > li.active").removeClass("active"),r("#topic_"+e).addClass("active"),r("#socket_"+e).addClass("active"),r("#chansock_"+e).addClass("active").removeClass("unread"),o=m[e];var n=r("#chansock_"+e).text();n&&(k.activeChannel=n),window.history.pushState(n,n,"/"+n.substring(1))}function x(e){if(!e)return V("'"+e+"' not a valid channel name"),!1;e=H(e),a.chatPanes.push(new n(e))}function j(e,t,n,i,s,a,r,o){var c,l=e.obj,h=m[l.id];if(h.timestamp=o,t===u.OP_SOCKET_MSG){if(!G(r,!0)){try{c=(new T).parse(r)}catch(e){return!1}switch(c.type){case f:h.sysmsg(c);break;case p:h.userJoin(c.nick);break;case d:h.userPart(c.nick);break;default:U(c,l.id,o)}}}else t===u.OP_CHANNEL_GETVAL?"topic"===a&&M(r,l.id):t===u.OP_CHANNEL_SETVAL&&("join"==a?h.userJoin(r):"topic"==a&&(M(r,l.id),V('channel topic changed to "'+r+'"')))}function A(e,t,n,i,s,a,r,o){var c,l=e.obj.id2;void 0===A.count&&(A.count=0);try{c=(new T).parse(r)}catch(e){return!1}void 0!==c.text&&U(c,l,o)}function B(e,t,n,i,s,a,r,o){M(r,e.obj.id2)}function G(e,t){if("/"!=e.substring(0,1))return!1;var n,i,s=e.split(" "),a=s[0].substring(1);switch(o&&!t&&0<=h.indexOf(a)&&o.send(e),t&&h.indexOf(a),a){case"?":return function(e){e.shift();for(var t=new LIBRECAST.Query;0<e.length;)t.filter(e.shift());return o.getmsg(A,t),!0}(s);case"help":return V("/help"),V("  commands: "),V("  /help                       - displays this help message"),V("  /nick nickname              - changes your channel nick"),V("  /topic channel topic        - set channel topic"),V("  /join channel               - join channel"),V("  /part [channel]             - leave active or specified channel"),V("  /random                     - join random channel"),V("  /reset                      - delete all local storage"),V("  /rtl                        - toggle right-to-left input"),V("  /who                        - list when users were last seen on channel"),V("  /upload                     - upload a file"),V("  /?                          - search messages eg:-"),V("  /? hello                    - search for messages containing the word 'hello'"),V("  /? time>2017-12-08          - search for messages after 2017-12-08"),V("  /? t<2017-12-08             - search for messages before 2017-12-08"),V("  /? nick=fred                - search for messages where nick='fred'"),V("  /? n=fred hello t<2017-12-08T12:00"),V("                              - messages by fred containing 'hello' before noon on 8th December 2017"),V(""),!0;case"join":return V('changing channels to "'+(i=H(s[1]))+'"'),-1===v.indexOf(i)?(x(i),k.activeChannel=i):N(D(i)),!0;case"nick":return I(s);case"part":return R(s);case"random":return S();case"reset":localStorage.clear();break;case"rtl":return r("#usercmd").toggleClass("rtl"),!0;case"sysmsg":return(n=s).shift(),V(n.join(" ")),!0;case"topic":return function(e,t){e.shift();var n=e.join(" ");return o&&o.setval("topic",n),!0}(s);case"upload":return r('input[name="filename"]').trigger("click"),!0;case"who":return function(){for(var e in V("Users on channel "+o.name+":"),o.users){var t=o.users[e];V(" "+t.nick+" (seen: "+t.lastSeen+")")}return!0}()}return!0}function Y(){var e,t=b();if(e=t,y.unshift(e),y.length>c&&y.pop(),!G(t)&&o){r("#usercmd").hasClass("rtl")&&(t=esrever.reverse(t));var n=new T(t);o.send(JSON.stringify(n))}O(""),E=-1,g=""}function e(){!function(){if(void 0!==k&&(_=k.nick,void 0!==k.channels))try{v=JSON.parse(k.channels)}catch(e){}void 0===_&&I([,Q()]);var e=window.location.pathname.substring(1);(e=H(e))&&(v.push(e),k.activeChannel=e)}(),a=new LIBRECAST.Context(function(){var t;(t=this).chatPanes=[],v.forEach(function(e){t.chatPanes.push(new n(e))}),void 0===k.activeChannel&&S()}),function(){r("#usercmd").keypress(function(e){e.which==t&&(e.preventDefault(),Y())}),r("#usercmd").keydown(function(e){switch(e.which){case s:e.preventDefault(),F(E+1);break;case i:e.preventDefault(),F(E-1)}});var n=r('div.uploader > form > input[name="filename"]');n.change(function(){var s=n[0].value,e=s.split("\\");if(1<e.length&&(s=e[e.length-1]),0<n.length){var t=r('<progress class="upload"></progress>');t.val(0),t.prop("max",100),W(t),r.ajax({url:"/upload/",type:"POST",data:new FormData(r("form")[0]),cache:!1,contentType:!1,processData:!1,xhr:function(){var e=r.ajaxSettings.xhr();return e.upload&&(e.upload.addEventListener("error",function(e){V("error uploading file")}),e.upload.addEventListener("load",function(e){V('"'+s+'" uploaded ('+e.loaded+" bytes)")}),e.upload.addEventListener("progress",function(e){t.prop("max",e.total),t.val(e.loaded)})),e},success:function(e){var t=r(e).find("sha1sum").text(),n="/files/"+t,i=new T;i.type=f,i.html='<pre><span class="sysmsg">'+_+' has uploaded a file <a href="'+n+'" download>'+s+"</a></span></pre>",o.send(JSON.stringify(i))}})}})}(),r("#usercmd").focus()}function K(e){e.obj.setval("join",_)}function Q(e){void 0===e&&(e="guest");var t=prompt('Welcome.  Please choose username ("nick") to continue',e);return t=null===t?_:t}function D(e){return r("li:contains("+e+")").attr("id").split("_")[1]}function J(e){e.obj.listen(j)}function P(e){var t=e?new Date(Number(e.toString().substring(0,13))):new Date,n=("0"+(t.getMonth()+1)).slice(-2),i=("0"+t.getDate()).slice(-2),s=("0"+t.getHours()).slice(-2),a=("0"+t.getMinutes()).slice(-2),r=("0"+t.getSeconds()).slice(-2);return'<span class="nanostamp">'+(e?e.toString():"")+"</span>"+('<span class="datestamp">'+t.getFullYear()+"-"+n+"-"+i+"&nbsp;</span>")+('<span class="timestamp">'+s+":"+a+":"+r+"&nbsp;</span>")}function M(e,t){var n;void 0!==(n=r(void 0===t?"div.topic.active":"#topic_"+t))&&n.html("<h1>"+e+"</h1>")}function H(e){return void 0!==e&&("#"!==(e=e.replace(/^s+|s+$/g,""))[0]&&(e="#"+e),!(e.length<2)&&e.toLowerCase())}function U(e,t,n){var i,s=m[t];if("object"==typeof e){if(void 0===e.text)return e.type===p?V(e.nick+" has joined "+s.name,t,n):e.type===d&&V(e.nick+" has left "+s.name,t,n),!1;i=r("<div>").text(e.format()).html()}else i=r("<div>").text(e).html();W('<p><span class="msg">'+P(n)+i+"</span></p>",t)}function V(e,t,n){var i=r("<div>").text(e).html();W('<pre><span class="sysmsg">'+P(n)+i+"</span></pre>",t)}function W(e,t){var n;(n=r(void 0===t?"div.socket.active":"#socket_"+t)).hasClass("active")||r("#chansock_"+t).addClass("unread"),void 0!==n&&(n.append(e),n.scrollTop(n.prop("scrollHeight")-n.prop("clientHeight")))}LIBRECAST.HAS_JQUERY?r(document).ready(function(){e()}):window.onload=function(){e()}}(jQuery,LIBRECAST);
