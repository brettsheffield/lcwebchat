!function(e,t){"use strict";function n(){var t=this;this.channels=[],this.socket=new LIBRECAST.Socket(b,_);for(var n=[this.socket.defer],i=0;i<arguments.length;i++){var s;try{(s=new LIBRECAST.Channel(b,arguments[i],W)).chatPane=this}catch(e){continue}this.channels.push(s),n.push(s.defer)}var a=this.socket;this.channels.forEach(function(t){e.when(a.defer,t.defer).done(function(){t.bindSocket(a,V),t.interval=setInterval(t.ping.bind(t),G)})}),e.when.apply(e,n).done(function(){t.onReady()})}function i(e){this.nick=e}function s(e){this.nick=U,this.text=e}function a(e){var t=e[1];return void 0===t&&(t=E(U)),S&&U&&S.send("/sysmsg "+U+" is now known as "+t),U=t,void 0!==H&&(H.nick=U),!0}function r(e){var t=C(e[1]);return w('changing channels to "'+t+'"'),-1===K.indexOf(t)?(!function(e){if(!e)return w("'"+e+"' not a valid channel name"),!1;e=C(e),b.chatPanes.push(new n(e))}(t),H.activeChannel=t):u(k(t)),!0}function o(t){var n;if(void 0!==t[1]){if(!(n=C(t[1])))return!0}else n=S.name;return w('parting channel "'+n+'"'),-1===K.indexOf(n)||(function(t){var n=k(t),i=Q[n],a=(new s).type(A);i.send(JSON.stringify(a)),function(e){for(var t=0,n=K.length;t<n;t++)if(K[t]===e.toLowerCase()){K.splice(K.indexOf(t)),H.channels=JSON.stringify(K);break}}(t),H.activeChannel===t&&u(k(K[0]));e("#socket_"+n).remove(),e("#chansock_"+n).remove()}(n),!0)}function c(){return e("#usercmd").val()}function h(t){e("#usercmd").val(t)}function l(e){if(e>J.length)e=J.length;else{if(e<0)return h(D),void(P=-1);0==e&&-1==P&&(D=c())}void 0!==J[e]&&(h(J[e]),P=e)}function u(t){var n=e("div.chat");n.find("div.topic").removeClass("active"),n.find("div.socket").removeClass("active"),e("div.channels > li.active").removeClass("active"),e("#topic_"+t).addClass("active"),e("#socket_"+t).addClass("active"),e("#chansock_"+t).addClass("active").removeClass("unread"),S=Q[t];var i=e("#chansock_"+t).text();i&&(H.activeChannel=i)}function p(e,n,i,a,r,o,c,h){var l,u=e.obj,p=Q[u.id];if(p.timestamp=h,n===t.OP_SOCKET_MSG){if(!v(c,!0)){try{l=(new s).parse(c)}catch(e){return!1}switch(l.type){case B:p.sysmsg(l);break;case j:p.userJoin(l.nick);break;case A:p.userPart(l.nick);break;default:I(l,u.id,h)}}}else n===t.OP_CHANNEL_GETVAL?"topic"===o&&T(c,u.id):n===t.OP_CHANNEL_SETVAL&&("join"==o?p.userJoin(c):"topic"==o&&(T(c,u.id),w('channel topic changed to "'+c+'"')))}function d(e,t,n,i,a,r,o,c){var h=e.obj.id2;void 0===d.count&&(d.count=0);var l;try{l=(new s).parse(o)}catch(e){return!1}void 0!==l.text&&I(l,h,c)}function f(e,t,n,i,s,a,r,o){T(r,e.obj.id2)}function v(t,n){if("/"!=t.substring(0,1))return!1;var i=t.split(" "),s=i[0].substring(1);switch(S&&!n&&Y.indexOf(s)>=0&&S.send(t),n&&Y.indexOf(s),s){case"?":return function(e){e.shift();for(var t=new LIBRECAST.Query;e.length>0;)t.filter(e.shift());return S.getmsg(d,t),!0}(i);case"help":return w("/help"),w("  commands: "),w("  /help                       - displays this help message"),w("  /nick nickname              - changes your channel nick"),w("  /topic channel topic        - set channel topic"),w("  /join channel               - join channel"),w("  /part [channel]             - leave active or specified channel"),w("  /reset                      - delete all local storage"),w("  /rtl                        - toggle right-to-left input"),w("  /who                        - list when users were last seen on channel"),w("  /upload                     - upload a file"),w("  /?                          - search messages eg:-"),w("  /? hello                    - search for messages containing the word 'hello'"),w("  /? time>2017-12-08          - search for messages after 2017-12-08"),w("  /? t<2017-12-08             - search for messages before 2017-12-08"),w("  /? nick=fred                - search for messages where nick='fred'"),w("  /? n=fred hello t<2017-12-08T12:00"),w("                              - messages by fred containing 'hello' before noon on 8th December 2017"),w(""),!0;case"join":return r(i);case"nick":return a(i);case"part":return o(i);case"reset":localStorage.clear();break;case"rtl":return e("#usercmd").toggleClass("rtl"),!0;case"sysmsg":return function(e){return e.shift(),w(e.join(" ")),!0}(i);case"topic":return function(e,t){e.shift();var n=e.join(" ");return S&&S.setval("topic",n),!0}(i);case"upload":return e('input[name="filename"]').trigger("click"),!0;case"who":return function(){w("Users on channel "+S.name+":");for(var e in S.users){var t=S.users[e];w(" "+t.nick+" (seen: "+t.lastSeen+")")}return!0}()}return!0}function m(){var t=c();if(function(e){J.unshift(e),J.length>x&&J.pop()}(t),S&&!v(t)){e("#usercmd").hasClass("rtl")&&(t=esrever.reverse(t));var n=new s(t);S.send(JSON.stringify(n))}h(""),P=-1,D=""}function g(){!function(){if(void 0!==H){if(U=H.nick,void 0!==H.channels)try{K=JSON.parse(H.channels)}catch(e){}0===K.length&&(K=[M],H.activeChannel=M)}else K=[M],H.activeChannel=M;void 0===U&&a([,E()])}(),b=new LIBRECAST.Context(function(){!function(e){e.chatPanes=[],K.forEach(function(t){e.chatPanes.push(new n(t))})}(this)}),function(){e("#usercmd").keypress(function(e){e.which==O&&(e.preventDefault(),m())}),e("#usercmd").keydown(function(e){switch(e.which){case N:e.preventDefault(),l(P+1);break;case F:e.preventDefault(),l(P-1)}});var t=e('div.uploader > form > input[name="filename"]');t.change(function(){var n=t[0].value,i=n.split("\\");if(i.length>1&&(n=i[i.length-1]),t.length>0){var a=e('<progress class="upload"></progress>');a.val(0),a.prop("max",100),R(a),e.ajax({url:"/upload/",type:"POST",data:new FormData(e("form")[0]),cache:!1,contentType:!1,processData:!1,xhr:function(){var t=e.ajaxSettings.xhr();return t.upload&&(t.upload.addEventListener("error",function(e){w("error uploading file")}),t.upload.addEventListener("load",function(e){w('"'+n+'" uploaded ('+e.loaded+" bytes)")}),t.upload.addEventListener("progress",function(e){a.prop("max",e.total),a.val(e.loaded)})),t},success:function(t){var i="/files/"+e(t).find("sha1sum").text(),a=new s;a.type=B,a.html='<pre><span class="sysmsg">'+U+' has uploaded a file <a href="'+i+'" download>'+n+"</a></span></pre>",S.send(JSON.stringify(a))}})}})}(),e("#usercmd").focus()}function y(e){e.obj.setval("join",U)}function E(e){void 0===e&&(e="guest");var t=prompt('Welcome.  Please choose username ("nick") to continue',e);return t=null===t?U:t}function k(t){return e("li:contains("+t+")").attr("id").split("_")[1]}function _(e){e.obj.listen(p)}function L(e){var t=e?new Date(Number(e.toString().substring(0,13))):new Date,n=("0"+(t.getMonth()+1)).slice(-2),i=("0"+t.getDate()).slice(-2),s=("0"+t.getHours()).slice(-2),a=("0"+t.getMinutes()).slice(-2),r=("0"+t.getSeconds()).slice(-2);return'<span class="nanostamp">'+(e?e.toString():"")+"</span>"+('<span class="datestamp">'+t.getFullYear()+"-"+n+"-"+i+"&nbsp;</span>")+('<span class="timestamp">'+s+":"+a+":"+r+"&nbsp;</span>")}function T(t,n){var i;void 0!==(i=e(void 0===n?"div.topic.active":"#topic_"+n))&&i.html("<h1>"+t+"</h1>")}function C(e){return void 0!==e&&("#"!==(e=e.replace(/^s+|s+$/g,""))[0]&&(e="#"+e),!(e.length<2)&&e.toLowerCase())}function I(t,n,i){var s,a=Q[n];if("object"==typeof t){if(void 0===t.text)return t.type===j?w(t.nick+" has joined "+a.name,n,i):t.type===A&&w(t.nick+" has left "+a.name,n,i),!1;s=e("<div>").text(t.format()).html()}else s=e("<div>").text(t).html();R('<p><span class="msg">'+L(i)+s+"</span></p>",n)}function w(t,n,i){var s=e("<div>").text(t).html();R('<pre><span class="sysmsg">'+L(i)+s+"</span></pre>",n)}function R(t,n){var i;(i=e(void 0===n?"div.socket.active":"#socket_"+n)).hasClass("active")||e("#chansock_"+n).addClass("unread"),void 0!==i&&(i.append(t),i.scrollTop(i.prop("scrollHeight")-i.prop("clientHeight")))}var S,b,O=13,F=40,N=38,x=32,j=1,A=2,B=3,G=5e3,Y=["sysmsg"],K=[],Q=[],D="",J=[],P=-1,M="#welcome",H=localStorage,U="guest";t.FILTER_KEY="k",t.FILTER_KEY_LONG="key",t.FILTER_NICK="n",t.FILTER_NICK_LONG="nick",t.FILTER_TIME="t",t.FILTER_TIME_LONG="time",t.FILTER_SHORT=[t.FILTER_KEY,t.FILTER_NICK,t.FILTER_TIME],t.FILTER_LONG=[t.FILTER_KEY_LONG,t.FILTER_NICK_LONG,t.FILTER_TIME_LONG],n.prototype.onReady=function(){},i.prototype.seen=function(e){return this.lastSeen=void 0===e?new Date:new Date(e),this},LIBRECAST.Channel.prototype.ping=function(){this.setval("join",U)},LIBRECAST.Channel.prototype.sysmsg=function(e){void 0!==e.html&&this.write(e.html)},LIBRECAST.Channel.prototype.userJoin=function(e){var t=this.id2;return void 0===this.userStatus(e)&&(this.users[e]=new i(e),w(e+" has joined "+this.name,t)),this.users[e].seen(),this},LIBRECAST.Channel.prototype.userPart=function(e){var t=this.id2;void 0===this.userStatus(e)&&(this.users[e]=new i(e),w(e+" has left "+this.name,t)),this.users[e].seen()},LIBRECAST.Channel.prototype.userStatus=function(e,t){return void 0===this.users&&(this.users=[]),void 0===t?this.users[e]:(this.users[e]=new i(e).seen(),this)},LIBRECAST.Channel.prototype.write=function(e){R(e,this.id2)},LIBRECAST.Filter=function(e){this.arg=e;var n=["<",">","="];for(var i in n)for(var s=0;s<e.length;s++)if(e[s]===n[i]){this.type=e.substring(0,s),"="===e[s+1]?(this.op=n[i]+"=",this.key=e.substring(s+2)):(this.op=n[i],this.key=e.substring(s+1));for(var a in t.FILTER_LONG)this.type===t.FILTER_LONG[a]&&(this.type=t.FILTER_SHORT[a]);if(this.type===t.FILTER_TIME){var r=moment(this.key);r.isValid()&&(this.key=r.format("x")+"000000")}return this}return this.type=t.FILTER_KEY,this.op="=",this.key=e,this},LIBRECAST.Query.prototype.filter=function(e){var n=new LIBRECAST.Filter(e);if(n.type===t.FILTER_KEY)this.key("message_keyword",n.key.toLowerCase().replace(/\W+/g,""));else if(n.type===t.FILTER_NICK)this.key("message_nick",n.key.toLowerCase().replace(/\W+/g,""));else if(n.type===t.FILTER_TIME){var i;for(var s in n.op)"<"===n.op[s]?i|=t.QUERY_LT:">"===n.op[s]?i|=t.QUERY_GT:"="===n.op[s]&&(i|=t.QUERY_EQ);void 0===i&&(i=t.QUERY_EQ),this.timestamp(n.key,i)}else this.filter(e.substring(1));return this},s.prototype.format=function(){return"<"+this.nick+"> "+this.text},s.prototype.parse=function(e){var t=JSON.parse(e);for(var n in t)this[n]=t[n];return this},s.prototype.type=function(e){return void 0===e?this.type:(this.type=e,this)};var V=function(){var n;for(var i in Q)if(Q[i].name===this.name){n=Q[i].timestamp;break}Q[this.id2]=this,H.activeChannel!=this.name&&void 0!==S||u(this.id2),function(t){var n=e("li:contains("+t.name+")"),i=t.id2;if(n.length){var s=n.attr("id").split("_")[1];e("li#chansock_"+s).attr("id","chansock_"+i),e("div#socket_"+s).attr("id","socket_"+i),e("div#topic_"+s).attr("id","topic_"+i)}else{var a=e("div.chat");a.append('<div id="topic_'+i+'" class="topic"></div>'),a.append('<div id="socket_'+i+'" class="socket"></div>'),n=e('<li id="chansock_'+i+'">'+t.name+"</li>"),e("div.channels").append(n),n.on("click",function(){u(e(this).attr("id").split("_")[1])})}H.activeChannel==t.name&&u(i)}(this),T(this.name,this.id2),this.getval("topic",f);var s=(new LIBRECAST.Query).timestamp(n,t.QUERY_GT);this.getmsg(d,s)},W=function(e){var t=e.obj;t.join(y),-1===K.indexOf(t.name)&&(K.push(t.name),H.channels=JSON.stringify(K))};LIBRECAST.HAS_JQUERY?e(document).ready(function(){g()}):window.onload=function(){g()}}(jQuery,LIBRECAST);
