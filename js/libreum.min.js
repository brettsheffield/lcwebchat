!function(e,n){"use strict";function t(){var n=this;this.channels=[],this.users=[],this.socket=new LIBRECAST.Socket(x,C);for(var t=[this.socket.defer],i=0;i<arguments.length;i++){var a;try{(a=new LIBRECAST.Channel(x,arguments[i],Y)).chatPane=this}catch(e){continue}this.channels.push(a),t.push(a.defer)}var s=this.socket;this.channels.forEach(function(n){e.when(s.defer,n.defer).done(function(){n.bindSocket(s,V)})}),e.when.apply(e,t).done(function(){n.onReady()})}function i(e){this.nick=Q,this.text=e}function a(e){var n=e[1];return void 0===n&&(n=k(Q)),O&&Q&&O.send("/sysmsg "+Q+" is now known as "+n),Q=n,void 0!==G&&(G.nick=Q),!0}function s(e){var n=_(e[1]);return b('changing channels to "'+n+'"'),-1===J.indexOf(n)?(!function(e){if(!e)return b("'"+e+"' not a valid channel name"),!1;e=_(e),x.chatPanes.push(new t(e))}(n),G.activeChannel=n):h(y(n)),!0}function c(n){var t;if(void 0!==n[1]){if(!(t=_(n[1])))return!0}else t=O.name;return b('parting channel "'+t+'"'),-1===J.indexOf(t)||(function(n){var t=y(n);(function(e){for(var n=0,t=J.length;n<t;n++)if(J[n]===e.toLowerCase()){delete J[n],G.channels=JSON.stringify(J);break}})(n),G.activeChannel===n&&h(y(J[0]));e("#socket_"+t).remove(),e("#chansock_"+t).remove()}(t),!0)}function o(){return e("#usercmd").val()}function r(n){e("#usercmd").val(n)}function l(e){if(e>B.length)e=B.length;else{if(e<0)return r(H),void(I=-1);0==e&&-1==I&&(H=o())}void 0!==B[e]&&(r(B[e]),I=e)}function h(n){var t=e("div.chat");t.find("div.topic").removeClass("active"),t.find("div.socket").removeClass("active"),e("div.channels > li.active").removeClass("active"),e("#topic_"+n).addClass("active"),e("#socket_"+n).addClass("active"),e("#chansock_"+n).addClass("active").removeClass("unread"),O=D[n];var i=e("#chansock_"+n).text();i&&(G.activeChannel=i)}function u(e,t,a,s,c,o,r,l){var h,u=e.obj,d=D[u.id];if(t===n.OP_SOCKET_MSG){if(!f(r,!0)){try{h=(new i).parse(r)}catch(e){return!1}switch(h.type){case T:b(h.nick+" has joined "+d.name,u.id);break;case P:b(h.nick+" has left "+d.name,u.id);break;default:S(h,u.id,l)}}}else t===n.OP_CHANNEL_GETVAL?w(r,u.id):t===n.OP_CHANNEL_SETVAL&&"topic"==o&&w(r,u.id)}function d(e,n,t,a,s,c,o,r){var l=e.obj.id2;void 0===d.count&&(d.count=0);var h;try{h=(new i).parse(o)}catch(e){return!1}S(h,l,r)}function v(e,n,t,i,a,s){w(s,e.obj.id)}function f(n,t){if("/"!=n.substring(0,1))return!1;var i=n.split(" "),o=i[0].substring(1);switch(O&&!t&&R.indexOf(o)>=0&&O.send(n),t&&R.indexOf(o),o){case"help":return b("/help"),b("  commands: "),b("  /help                       - displays this help message"),b("  /nick nickname              - changes your channel nick"),b("  /topic channel topic        - set channel topic"),b("  /join channel               - join channel"),b("  /part [channel]             - leave active or specified channel"),b("  /reset                      - delete all local storage"),b("  /rtl                        - toggle right-to-left input"),b(""),!0;case"join":return s(i);case"nick":return a(i);case"part":return c(i);case"reset":localStorage.clear();break;case"rtl":return e("#usercmd").toggleClass("rtl"),!0;case"sysmsg":return function(e){return e.shift(),b(e.join(" ")),!0}(i);case"topic":return function(e,n){e.shift();var t=e.join(" ");return b('channel topic changed to "'+t+'"'),O&&O.setval("topic",t),!0}(i)}return!0}function p(){var n=o();if(function(e){B.unshift(e),B.length>N&&B.pop()}(n),O&&!f(n)){e("#usercmd").hasClass("rtl")&&(n=esrever.reverse(n));var t=new i(n);O.send(JSON.stringify(t))}r(""),I=-1,H=""}function m(){!function(){if(void 0!==G){if(Q=G.nick,void 0!==G.channels)try{J=JSON.parse(G.channels)}catch(e){}0===J.length&&(J=[M],G.activeChannel=M)}else J=[M],G.activeChannel=M;void 0===Q&&a([,k()])}(),x=new LIBRECAST.Context(function(){!function(e){e.chatPanes=[],J.forEach(function(n){e.chatPanes.push(new t(n))})}(this)}),e("#usercmd").keypress(function(e){e.which==E&&(e.preventDefault(),p())}),e("#usercmd").keydown(function(e){switch(e.which){case A:e.preventDefault(),l(I+1);break;case L:e.preventDefault(),l(I-1)}}),e("#usercmd").focus()}function g(e){var n=e.obj,t=(new i).type(T);n.send(JSON.stringify(t))}function k(e){void 0===e&&(e="guest");var n=prompt('Welcome.  Please choose username ("nick") to continue',e);return n=null===n?Q:n}function y(n){return e("li:contains("+n+")").attr("id").split("_")[1]}function C(e){e.obj.listen(u)}function _(e){return void 0!==e&&("#"!==(e=e.replace(/^s+|s+$/g,""))[0]&&(e="#"+e),!(e.length<2)&&e.toLowerCase())}function w(n,t){var i;void 0!==(i=e(void 0===t?"div.topic.active":"#topic_"+t))&&i.html("<h1>"+n+"</h1>")}function S(n,t,i){var a;if("object"==typeof n){if(void 0===n.text)return!1;a=e("<div>").text(n.format()).html()}else a=e("<div>").text(n).html();var s=void 0===i||0===i?new Date:new Date(i),c=("0"+(s.getMonth()+1)).slice(-2),o=("0"+s.getDate()).slice(-2),r=("0"+s.getHours()).slice(-2),l=("0"+s.getMinutes()).slice(-2),h=("0"+s.getSeconds()).slice(-2);j('<p><span class="msg">'+('<span class="datestamp">'+s.getFullYear()+"-"+c+"-"+o+"&nbsp;</span>")+('<span class="timestamp">'+r+":"+l+":"+h+"&nbsp;</span>")+a+"</span></p>",t)}function b(n,t){j('<pre><span class="sysmsg">'+e("<div>").text(n).html()+"</span></pre>",t)}function j(n,t){var i;(i=e(void 0===t?"div.socket.active":"#socket_"+t)).hasClass("active")||e("#chansock_"+t).addClass("unread"),void 0!==i&&(i.append(n),i.scrollTop(i.prop("scrollHeight")-i.prop("clientHeight")))}var O,x,E=13,L=40,A=38,N=32,T=1,P=2,R=["sysmsg"],J=[],D=[],H="",B=[],I=-1,M="#welcome",G=localStorage,Q="guest";t.prototype.onReady=function(){},i.prototype.format=function(){return"<"+this.nick+"> "+this.text},i.prototype.parse=function(e){var n=JSON.parse(e);for(var t in n)this[t]=n[t];return this},i.prototype.type=function(e){return void 0===e?this.type:(this.type=e,this)};var V=function(){D[this.id2]=this,G.activeChannel!=this.name&&void 0!==O||h(this.id2),function(n){var t=e("li:contains("+n.name+")"),i=n.id2;if(t.length){var a=t.attr("id").split("_")[1];e("li#chansock_"+a).attr("id","chansock_"+i),e("div#socket_"+a).attr("id","socket_"+i),e("div#topic_"+a).attr("id","topic_"+i)}else{var s=e("div.chat");s.append('<div id="topic_'+i+'" class="topic"></div>'),s.append('<div id="socket_'+i+'" class="socket"></div>'),t=e('<li id="chansock_'+i+'">'+n.name+"</li>"),e("div.channels").append(t),t.on("click",function(){h(e(this).attr("id").split("_")[1])})}G.activeChannel==n.name&&h(i)}(this),w(this.name,this.id2),this.getval("topic",v),this.getmsg(d)},Y=function(e){var n=e.obj;n.join(g),-1===J.indexOf(n.name)&&(J.push(n.name),G.channels=JSON.stringify(J))};LIBRECAST.HAS_JQUERY?e(document).ready(function(){m()}):window.onload=function(){m()}}(jQuery,LIBRECAST);
