!function(n,e){"use strict";function t(){n("#usercmd").keypress(function(e){e.which==E&&(e.preventDefault(),function(){var e=c();(function(n){J.unshift(n),J.length>A&&J.pop()})(e),S&&(_(e)||(n("#usercmd").hasClass("rtl")&&(e=esrever.reverse(e)),S.send("<"+I+">  "+e)));s(""),P=-1,H=""}())}),n("#usercmd").keydown(function(n){switch(n.which){case L:n.preventDefault(),o(P+1);break;case x:n.preventDefault(),o(P-1)}})}function i(n){void 0===n&&(n="guest");var e=prompt('Welcome.  Please choose username ("nick") to continue',n);return e=null===e?I:e}function a(){!function(){if(void 0!==B){if(I=B.nick,void 0!==B.channels)try{T=JSON.parse(B.channels)}catch(n){}0===T.length&&(T=[R],B.activeChannel=R)}else T=[R],B.activeChannel=R;void 0===I&&(I=i())}(),O=new LIBRECAST.Context(function(){T.forEach(function(n){v(n)})}),t(),n("#usercmd").focus()}function c(){return n("#usercmd").val()}function s(e){n("#usercmd").val(e)}function o(n){if(n>J.length)n=J.length;else{if(n<0)return s(H),void(P=-1);0==n&&-1==P&&(H=c())}void 0!==J[n]&&(s(J[n]),P=n)}function r(e){var t=n("div.chat");t.find("div.topic").removeClass("active"),t.find("div.socket").removeClass("active"),n("div.channels > li.active").removeClass("active"),n("#topic_"+e).addClass("active"),n("#socket_"+e).addClass("active"),n("#chansock_"+e).addClass("active").removeClass("unread"),S=D[e];var i=n("#chansock_"+e).text();i&&(B.activeChannel=i)}function l(e){var t=d(e);!function(n){for(var e=0,t=T.length;e<t;e++)if(T[e]===n.toLowerCase()){delete T[e],B.channels=JSON.stringify(T);break}}(e),B.activeChannel===e&&r(d(T[0])),n("#socket_"+t).remove(),n("#chansock_"+t).remove()}function d(e){return n("li:contains("+e+")").attr("id").split("_")[1]}function u(n){return void 0!==n&&("#"!==(n=n.replace(/^s+|s+$/g,""))[0]&&(n="#"+n),!(n.length<2)&&n.toLowerCase())}function v(t){if(!t)return j("'"+t+"' not a valid channel name"),!1;t=u(t);var i=[],a=new e.Socket(O,f),c=new e.Channel(O,t,h);i.push(a.defer),i.push(c.defer),n.when.apply(n,i).done(function(){c.bind(a,g)})}function h(n){var e=n.obj;e.join(m),-1===T.indexOf(e.name)&&(T.push(e.name),B.channels=JSON.stringify(T))}function p(n,e,t,i,a,c){w(c,n.obj.id)}function f(n){n.obj.listen(k)}function g(e){var t=e.obj;D[t.id2]=t,B.activeChannel!=t.name&&void 0!==S||r(t.id2),function(e){var t=n("li:contains("+e.name+")"),i=e.id2;if(t.length){var a=t.attr("id").split("_")[1];n("li#chansock_"+a).attr("id","chansock_"+i),n("div#socket_"+a).attr("id","socket_"+i),n("div#topic_"+a).attr("id","topic_"+i)}else{var c=n("div.chat");c.append('<div id="topic_'+i+'" class="topic"></div>'),c.append('<div id="socket_'+i+'" class="socket"></div>'),t=n('<li id="chansock_'+i+'">'+e.name+"</li>"),n("div.channels").append(t),t.on("click",function(){r(n(this).attr("id").split("_")[1])})}B.activeChannel==e.name&&r(i)}(t),w(t.name,t.id2),t.getval("topic",p),t.getmsg(C)}function m(n){var e=n.obj;e.send("/sysmsg "+I+" has joined "+e.name)}function k(n,t,i,a,c,s,o,r){var l=n.obj.id;t===e.OP_SOCKET_MSG?_(o,!0)||b(o,l,r):t===e.OP_CHANNEL_GETVAL?w(o,l):t===e.OP_CHANNEL_SETVAL&&"topic"==s&&w(o,l)}function C(n,e,t,i,a,c,s,o){var r=n.obj.id2;void 0===C.count&&(C.count=0),"/"!=s.substring(0,1)&&"topic"!==s&&b(s,r,o)}function _(e,t){if("/"!=e.substring(0,1))return!1;var a=e.split(" "),c=a[0].substring(1);switch(S&&!t&&N.indexOf(c)>=0&&S.send(e),t&&N.indexOf(c),c){case"help":return j("/help"),j("  commands: "),j("  /help                       - displays this help message"),j("  /nick nickname              - changes your channel nick"),j("  /topic channel topic        - set channel topic"),j("  /join channel               - join channel"),j("  /part [channel]             - leave active or specified channel"),j("  /reset                      - delete all local storage"),j("  /rtl                        - toggle right-to-left input"),j(""),!0;case"join":return function(n){var e=u(n[1]);return j('changing channels to "'+e+'"'),-1===T.indexOf(e)?(v(e),B.activeChannel=e):r(d(e)),!0}(a);case"nick":return function(n){var e=n[1];return void 0===e&&(e=i(I)),S&&I&&S.send("/sysmsg "+I+" is now known as "+e),I=e,void 0!==B&&(B.nick=I),!0}(a);case"part":return function(n){var e;if(void 0!==n[1]){if(!(e=u(n[1])))return!0}else e=S.name;return j('parting channel "'+e+'"'),-1===T.indexOf(e)||(l(e),!0)}(a);case"reset":localStorage.clear();break;case"rtl":return n("#usercmd").toggleClass("rtl"),!0;case"sysmsg":return function(n){return n.shift(),j(n.join(" ")),!0}(a);case"topic":return function(n,e){n.shift();var t=n.join(" ");return j('channel topic changed to "'+t+'"'),S&&S.setval("topic",t),!0}(a)}return!0}function w(e,t){var i;void 0!==(i=n(void 0===t?"div.topic.active":"#topic_"+t))&&i.html("<h1>"+e+"</h1>")}function b(e,t,i){var a=n("<div>").text(e).html(),c=void 0===i||0===i?new Date:new Date(i),s=("0"+(c.getMonth()+1)).slice(-2),o=("0"+c.getDate()).slice(-2),r=("0"+c.getHours()).slice(-2),l=("0"+c.getMinutes()).slice(-2),d=("0"+c.getSeconds()).slice(-2);y('<p><span class="msg">'+('<span class="datestamp">'+c.getFullYear()+"-"+s+"-"+o+"&nbsp;</span>")+('<span class="timestamp">'+r+":"+l+":"+d+"&nbsp;</span>")+a+"</span></p>",t)}function j(e,t){y('<pre><span class="sysmsg">'+n("<div>").text(e).html()+"</span></pre>",t)}function y(e,t){var i;(i=n(void 0===t?"div.socket.active":"#socket_"+t)).hasClass("active")||n("#chansock_"+t).addClass("unread"),void 0!==i&&(i.append(e),i.scrollTop(i.prop("scrollHeight")-i.prop("clientHeight")))}var S,O,E=13,x=40,L=38,A=32,N=["sysmsg"],T=[],D=[],H="",J=[],P=-1,R="#welcome",B=localStorage,I="guest";LIBRECAST.HAS_JQUERY?n(document).ready(function(){a()}):window.onload=function(){a()}}(jQuery,LIBRECAST);
