!function(n,e){"use strict";function t(){var e=this;this.channels=[],this.users=[],this.socket=new LIBRECAST.Socket(E,C);for(var t=[this.socket.defer],i=0;i<arguments.length;i++){var s;try{(s=new LIBRECAST.Channel(E,arguments[i],G)).chatPane=this}catch(n){continue}this.channels.push(s),t.push(s.defer)}var a=this.socket;this.channels.forEach(function(e){n.when(a.defer,e.defer).done(function(){e.bindSocket(a,M)})}),n.when.apply(n,t).done(function(){e.onReady()})}function i(n){var e=n[1];return void 0===e&&(e=m(J)),j&&J&&j.send("/sysmsg "+J+" is now known as "+e),J=e,void 0!==I&&(I.nick=J),!0}function s(n){var e=_(n[1]);return S('changing channels to "'+e+'"'),-1===P.indexOf(e)?(!function(n){if(!n)return S("'"+n+"' not a valid channel name"),!1;n=_(n),E.chatPanes.push(new t(n))}(e),I.activeChannel=e):l(k(e)),!0}function a(e){var t;if(void 0!==e[1]){if(!(t=_(e[1])))return!0}else t=j.name;return S('parting channel "'+t+'"'),-1===P.indexOf(t)||(function(e){var t=k(e);(function(n){for(var e=0,t=P.length;e<t;e++)if(P[e]===n.toLowerCase()){delete P[e],I.channels=JSON.stringify(P);break}})(e),I.activeChannel===e&&l(k(P[0]));n("#socket_"+t).remove(),n("#chansock_"+t).remove()}(t),!0)}function c(){return n("#usercmd").val()}function o(e){n("#usercmd").val(e)}function r(n){if(n>D.length)n=D.length;else{if(n<0)return o(N),void(H=-1);0==n&&-1==H&&(N=c())}void 0!==D[n]&&(o(D[n]),H=n)}function l(e){var t=n("div.chat");t.find("div.topic").removeClass("active"),t.find("div.socket").removeClass("active"),n("div.channels > li.active").removeClass("active"),n("#topic_"+e).addClass("active"),n("#socket_"+e).addClass("active"),n("#chansock_"+e).addClass("active").removeClass("unread"),j=R[e];var i=n("#chansock_"+e).text();i&&(I.activeChannel=i)}function h(n,t,i,s,a,c,o,r){var l=n.obj.id;t===e.OP_SOCKET_MSG?v(o,!0)||y(o,l,r):t===e.OP_CHANNEL_GETVAL?w(o,l):t===e.OP_CHANNEL_SETVAL&&"topic"==c&&w(o,l)}function u(n,e,t,i,s,a,c,o){var r=n.obj.id2;void 0===u.count&&(u.count=0),"/"!=c.substring(0,1)&&"topic"!==c&&y(c,r,o)}function d(n,e,t,i,s,a){w(a,n.obj.id)}function v(e,t){if("/"!=e.substring(0,1))return!1;var c=e.split(" "),o=c[0].substring(1);switch(j&&!t&&T.indexOf(o)>=0&&j.send(e),t&&T.indexOf(o),o){case"help":return S("/help"),S("  commands: "),S("  /help                       - displays this help message"),S("  /nick nickname              - changes your channel nick"),S("  /topic channel topic        - set channel topic"),S("  /join channel               - join channel"),S("  /part [channel]             - leave active or specified channel"),S("  /reset                      - delete all local storage"),S("  /rtl                        - toggle right-to-left input"),S(""),!0;case"join":return s(c);case"nick":return i(c);case"part":return a(c);case"reset":localStorage.clear();break;case"rtl":return n("#usercmd").toggleClass("rtl"),!0;case"sysmsg":return function(n){return n.shift(),S(n.join(" ")),!0}(c);case"topic":return function(n,e){n.shift();var t=n.join(" ");return S('channel topic changed to "'+t+'"'),j&&j.setval("topic",t),!0}(c)}return!0}function f(){var e=c();!function(n){D.unshift(n),D.length>x&&D.pop()}(e),j&&(v(e)||(n("#usercmd").hasClass("rtl")&&(e=esrever.reverse(e)),j.send("<"+J+">  "+e))),o(""),H=-1,N=""}function p(){!function(){if(void 0!==I){if(J=I.nick,void 0!==I.channels)try{P=JSON.parse(I.channels)}catch(n){}0===P.length&&(P=[B],I.activeChannel=B)}else P=[B],I.activeChannel=B;void 0===J&&i([,m()])}(),E=new LIBRECAST.Context(function(){!function(n){n.chatPanes=[],P.forEach(function(e){n.chatPanes.push(new t(e))})}(this)}),n("#usercmd").keypress(function(n){n.which==O&&(n.preventDefault(),f())}),n("#usercmd").keydown(function(n){switch(n.which){case A:n.preventDefault(),r(H+1);break;case L:n.preventDefault(),r(H-1)}}),n("#usercmd").focus()}function g(n){var e=n.obj;e.send("/sysmsg "+J+" has joined "+e.name)}function m(n){void 0===n&&(n="guest");var e=prompt('Welcome.  Please choose username ("nick") to continue',n);return e=null===e?J:e}function k(e){return n("li:contains("+e+")").attr("id").split("_")[1]}function C(n){n.obj.listen(h)}function _(n){return void 0!==n&&("#"!==(n=n.replace(/^s+|s+$/g,""))[0]&&(n="#"+n),!(n.length<2)&&n.toLowerCase())}function w(e,t){var i;void 0!==(i=n(void 0===t?"div.topic.active":"#topic_"+t))&&i.html("<h1>"+e+"</h1>")}function y(e,t,i){var s=n("<div>").text(e).html(),a=void 0===i||0===i?new Date:new Date(i),c=("0"+(a.getMonth()+1)).slice(-2),o=("0"+a.getDate()).slice(-2),r=("0"+a.getHours()).slice(-2),l=("0"+a.getMinutes()).slice(-2),h=("0"+a.getSeconds()).slice(-2);b('<p><span class="msg">'+('<span class="datestamp">'+a.getFullYear()+"-"+c+"-"+o+"&nbsp;</span>")+('<span class="timestamp">'+r+":"+l+":"+h+"&nbsp;</span>")+s+"</span></p>",t)}function S(e,t){b('<pre><span class="sysmsg">'+n("<div>").text(e).html()+"</span></pre>",t)}function b(e,t){var i;(i=n(void 0===t?"div.socket.active":"#socket_"+t)).hasClass("active")||n("#chansock_"+t).addClass("unread"),void 0!==i&&(i.append(e),i.scrollTop(i.prop("scrollHeight")-i.prop("clientHeight")))}var j,E,O=13,L=40,A=38,x=32,T=["sysmsg"],P=[],R=[],N="",D=[],H=-1,B="#welcome",I=localStorage,J="guest";t.prototype.onReady=function(){};var M=function(){R[this.id2]=this,I.activeChannel!=this.name&&void 0!==j||l(this.id2),function(e){var t=n("li:contains("+e.name+")"),i=e.id2;if(t.length){var s=t.attr("id").split("_")[1];n("li#chansock_"+s).attr("id","chansock_"+i),n("div#socket_"+s).attr("id","socket_"+i),n("div#topic_"+s).attr("id","topic_"+i)}else{var a=n("div.chat");a.append('<div id="topic_'+i+'" class="topic"></div>'),a.append('<div id="socket_'+i+'" class="socket"></div>'),t=n('<li id="chansock_'+i+'">'+e.name+"</li>"),n("div.channels").append(t),t.on("click",function(){l(n(this).attr("id").split("_")[1])})}I.activeChannel==e.name&&l(i)}(this),w(this.name,this.id2),this.getval("topic",d),this.getmsg(u)},G=function(n){var e=n.obj;e.join(g),-1===P.indexOf(e.name)&&(P.push(e.name),I.channels=JSON.stringify(P))};LIBRECAST.HAS_JQUERY?n(document).ready(function(){p()}):window.onload=function(){p()}}(jQuery,LIBRECAST);
