!function(n,e){"use strict";function o(){if(console.log("init()"),void 0!==B){if(void 0!==B.nick&&(G=B.nick),void 0!==B.channels)try{N=JSON.parse(B.channels)}catch(n){console.log("no channels loaded")}if(0===N.length&&(N=[J],B.activeChannel=J),void 0===B.nick){var e=prompt('Welcome.  Please choose username ("nick") to continue',"guest");C([,e=null===e?G:e])}console.log(N)}S=new LIBRECAST.Librecast(s),n("#usercmd").keypress(function(e){e.which==L&&(e.preventDefault(),function(){var e=t();(function(n){console.log("cmdHistorySet("+n+")"),P.unshift(n),P.length>H&&P.pop()})(e),O&&(y(e)||(n("#usercmd").hasClass("rtl")&&(e=esrever.reverse(e)),console.log("sending "+e),O.send("<"+G+">  "+e)));c(""),R=-1,T=""}())}),n("#usercmd").keydown(function(n){switch(n.which){case x:console.log("UP"),n.preventDefault(),i(R+1);break;case E:console.log("DOWN"),n.preventDefault(),i(R-1)}}),n("#usercmd").focus()}function t(){return n("#usercmd").val()}function c(e){n("#usercmd").val(e)}function i(n){if(console.log("cmdHistoryGet("+n+")"),n>P.length)n=P.length;else{if(n<0)return console.log("restoring current command"),c(T),void(R=-1);0==n&&-1==R&&(console.log("stashing command history"),T=t())}void 0!==P[n]&&(console.log("getting cmdHistory"),c(P[n]),R=n)}function s(){console.log("librecastCtxReady()"),N.forEach(function(n){console.log(n),u(n)})}function a(e){var o=n("div.chat");o.find("div.topic").removeClass("active"),o.find("div.socket").removeClass("active"),n("div.channels > li.active").removeClass("active"),n("#topic_"+e).addClass("active"),n("#socket_"+e).addClass("active"),n("#chansock_"+e).addClass("active").removeClass("unread"),O=D[e];var t=n("#chansock_"+e).text();t&&(B.activeChannel=t)}function l(e){console.log("partChannel("+e+")");var o=r(e);!function(n){for(var e=0,o=N.length;e<o;e++)if(N[e]===n.toLowerCase()){delete N[e],B.channels=JSON.stringify(N);break}}(e),B.activeChannel===e&&a(r(N[0])),n("#socket_"+o).remove(),n("#chansock_"+o).remove()}function r(e){return n("li:contains("+e+")").attr("id").split("_")[1]}function d(n){return void 0!==n&&("#"!==(n=n.replace(/^s+|s+$/g,""))[0]&&(n="#"+n),!(n.length<2)&&n.toLowerCase())}function u(o){if(!o)return w("'"+o+"' not a valid channel name"),!1;o=d(o);var t=[],c=new e.LibrecastSocket(S,g),i=new e.LibrecastChannel(S,o,v);t.push(c.defer),t.push(i.defer),n.when.apply(n,t).done(function(){console.log("socket and channel both ready ("+i.name+")"),console.log("socket id="+c.id),console.log("channel id="+i.id),i.bind(c,p)})}function v(n){var e=n.obj;console.log("channel "+e.name+" is ready"),e.join(f),-1===N.indexOf(e.name)&&(N.push(e.name),B.channels=JSON.stringify(N))}function h(n,e,o,t,c,i){_(i,n.obj.id)}function g(n){console.log("my socket is ready");n.obj.listen(m)}function p(e){var o=e.obj;D[o.id2]=o,B.activeChannel!=o.name&&void 0!==O||a(o.id2),console.log("channel "+o.name+" bound to socket "+o.id2),function(e){var o=n("li:contains("+e.name+")"),t=e.id2;if(o.length){var c=o.attr("id").split("_")[1];n("li#chansock_"+c).attr("id","chansock_"+t),n("div#socket_"+c).attr("id","socket_"+t),n("div#topic_"+c).attr("id","topic_"+t)}else{var i=n("div.chat");i.append('<div id="topic_'+t+'" class="topic"></div>'),i.append('<div id="socket_'+t+'" class="socket"></div>'),o=n('<li id="chansock_'+t+'">'+e.name+"</li>"),n("div.channels").append(o),o.on("click",function(){a(n(this).attr("id").split("_")[1])})}B.activeChannel==e.name&&a(t)}(o),_(o.name,o.id2),o.getval("topic",h),o.getmsg(k)}function f(n){var e=n.obj;console.log("channel "+e.name+" joined"),e.send("/sysmsg "+G+" has joined "+e.name)}function m(n,o,t,c,i,s,a,l){console.log("gotmail()");var r=n.obj.id;o===e.OP_SOCKET_MSG?y(a,!0)||b(a,r,l):o===e.OP_CHANNEL_GETVAL?_(a,r):o===e.OP_CHANNEL_SETVAL&&("topic"==s?_(a,r):console.log("ignoring unknown key '"+s+"'"))}function k(n,e,o,t,c,i,s,a){var l=n.obj.id2;void 0===k.count&&(k.count=0),console.log("socket "+t+": got a message result "+ ++k.count),console.log(s),"/"!=s.substring(0,1)&&"topic"!==s&&b(s,l,a)}function C(n){var e=n[1];return O&&G&&O.send("/sysmsg "+G+" is now known as "+e),G=e,void 0!==B&&(B.nick=G),!0}function _(e,o){var t;void 0!==(t=n(void 0===o?"div.topic.active":"#topic_"+o))&&t.html("<h1>"+e+"</h1>")}function y(e,o){if("/"!=e.substring(0,1))return!1;var t=e.split(" "),c=t[0].substring(1);switch(O&&!o&&A.indexOf(c)>=0&&O.send(e),o&&A.indexOf(c)<0&&console.log("bad remote command received: "+c),c){case"help":return w("/help"),w("  commands: "),w("  /help                       - displays this help message"),w("  /nick nickname              - changes your channel nick"),w("  /topic channel topic        - set channel topic"),w("  /join channel               - join channel"),w("  /part [channel]             - leave active or specified channel"),w("  /reset                      - delete all local storage"),w("  /rtl                        - toggle right-to-left input"),w(""),!0;case"join":return function(n){var e=d(n[1]);return w('changing channels to "'+e+'"'),console.log(N),-1===N.indexOf(e)?(u(e),B.activeChannel=e):(console.log("already joined to channel '"+e+"'"),a(r(e))),!0}(t);case"nick":return C(t);case"part":return function(n){var e;if(void 0!==n[1]){if(!(e=d(n[1])))return console.log("invalid channel name"),!0}else e=O.name;return w('parting channel "'+e+'"'),-1===N.indexOf(e)?(console.log("invalid channel name"),!0):(l(e),!0)}(t);case"reset":B.clear(),console.log("local storage wiped");break;case"rtl":return n("#usercmd").toggleClass("rtl"),!0;case"sysmsg":return function(n){return n.shift(),w(n.join(" ")),!0}(t);case"topic":return function(n,e){n.shift();var o=n.join(" ");return w('channel topic changed to "'+o+'"'),O&&O.setval("topic",o),!0}(t)}return!0}function b(e,o,t){var c=n("<div>").text(e).html(),i=void 0===t||0===t?new Date:new Date(t),s=("0"+(i.getMonth()+1)).slice(-2),a=("0"+i.getDate()).slice(-2),l=("0"+i.getHours()).slice(-2),r=("0"+i.getMinutes()).slice(-2),d=("0"+i.getSeconds()).slice(-2);j('<p><span class="msg">'+('<span class="datestamp">'+i.getFullYear()+"-"+s+"-"+a+"&nbsp;</span>")+('<span class="timestamp">'+l+":"+r+":"+d+"&nbsp;</span>")+c+"</span></p>",o)}function w(e,o){j('<pre><span class="sysmsg">'+n("<div>").text(e).html()+"</span></pre>",o)}function j(e,o){var t;(t=n(void 0===o?"div.socket.active":"#socket_"+o)).hasClass("active")||n("#chansock_"+o).addClass("unread"),void 0!==t&&(t.append(e),t.scrollTop(t.prop("scrollHeight")-t.prop("clientHeight")))}var O,S,L=13,E=40,x=38,H=32,A=["sysmsg"],N=[],D=[],T="",P=[],R=-1,J="#welcome",B=B,G="guest";LIBRECAST.HAS_JQUERY?n(document).ready(function(){console.log("document loaded (jQuery)"),o()}):window.onload=function(){console.log("document loaded"),o()}}(jQuery,LIBRECAST);
