!function(n,e){"use strict";function t(e){var t=e.obj;H[t.id2]=t,I.activeChannel!=t.name&&void 0!==O||l(t.id2),function(e){var t=n("li:contains("+e.name+")"),i=e.id2;if(t.length){var a=t.attr("id").split("_")[1];n("li#chansock_"+a).attr("id","chansock_"+i),n("div#socket_"+a).attr("id","socket_"+i),n("div#topic_"+a).attr("id","topic_"+i)}else{var c=n("div.chat");c.append('<div id="topic_'+i+'" class="topic"></div>'),c.append('<div id="socket_'+i+'" class="socket"></div>'),t=n('<li id="chansock_'+i+'">'+e.name+"</li>"),n("div.channels").append(t),t.on("click",function(){l(n(this).attr("id").split("_")[1])})}I.activeChannel==e.name&&l(i)}(t),b(t.name,t.id2),t.getval("topic",h),t.getmsg(v)}function i(n){var e=n.obj;e.join(m),-1===D.indexOf(e.name)&&(D.push(e.name),I.channels=JSON.stringify(D))}function a(n){var e=n[1];return void 0===e&&(e=k(M)),O&&M&&O.send("/sysmsg "+M+" is now known as "+e),M=e,void 0!==I&&(I.nick=M),!0}function c(e){var t;if(void 0!==e[1]){if(!(t=w(e[1])))return!0}else t=O.name;return y('parting channel "'+t+'"'),-1===D.indexOf(t)||(function(e){var t=C(e);(function(n){for(var e=0,t=D.length;e<t;e++)if(D[e]===n.toLowerCase()){delete D[e],I.channels=JSON.stringify(D);break}})(e),I.activeChannel===e&&l(C(D[0]));n("#socket_"+t).remove(),n("#chansock_"+t).remove()}(t),!0)}function s(){return n("#usercmd").val()}function o(e){n("#usercmd").val(e)}function r(n){if(n>P.length)n=P.length;else{if(n<0)return o(J),void(R=-1);0==n&&-1==R&&(J=s())}void 0!==P[n]&&(o(P[n]),R=n)}function l(e){var t=n("div.chat");t.find("div.topic").removeClass("active"),t.find("div.socket").removeClass("active"),n("div.channels > li.active").removeClass("active"),n("#topic_"+e).addClass("active"),n("#socket_"+e).addClass("active"),n("#chansock_"+e).addClass("active").removeClass("unread"),O=H[e];var i=n("#chansock_"+e).text();i&&(I.activeChannel=i)}function d(a){if(!a)return y("'"+a+"' not a valid channel name"),!1;a=w(a);var c=[],s=new e.Socket(E,_),o=new e.Channel(E,a,i);c.push(s.defer),c.push(o.defer),n.when.apply(n,c).done(function(){o.bind(s,t)})}function u(n,t,i,a,c,s,o,r){var l=n.obj.id;t===e.OP_SOCKET_MSG?p(o,!0)||j(o,l,r):t===e.OP_CHANNEL_GETVAL?b(o,l):t===e.OP_CHANNEL_SETVAL&&"topic"==s&&b(o,l)}function v(n,e,t,i,a,c,s,o){var r=n.obj.id2;void 0===v.count&&(v.count=0),"/"!=s.substring(0,1)&&"topic"!==s&&j(s,r,o)}function h(n,e,t,i,a,c){b(c,n.obj.id)}function p(e,t){if("/"!=e.substring(0,1))return!1;var i=e.split(" "),s=i[0].substring(1);switch(O&&!t&&T.indexOf(s)>=0&&O.send(e),t&&T.indexOf(s),s){case"help":return y("/help"),y("  commands: "),y("  /help                       - displays this help message"),y("  /nick nickname              - changes your channel nick"),y("  /topic channel topic        - set channel topic"),y("  /join channel               - join channel"),y("  /part [channel]             - leave active or specified channel"),y("  /reset                      - delete all local storage"),y("  /rtl                        - toggle right-to-left input"),y(""),!0;case"join":return function(n){var e=w(n[1]);return y('changing channels to "'+e+'"'),-1===D.indexOf(e)?(d(e),I.activeChannel=e):l(C(e)),!0}(i);case"nick":return a(i);case"part":return c(i);case"reset":localStorage.clear();break;case"rtl":return n("#usercmd").toggleClass("rtl"),!0;case"sysmsg":return function(n){return n.shift(),y(n.join(" ")),!0}(i);case"topic":return function(n,e){n.shift();var t=n.join(" ");return y('channel topic changed to "'+t+'"'),O&&O.setval("topic",t),!0}(i)}return!0}function f(){var e=s();!function(n){P.unshift(n),P.length>N&&P.pop()}(e),O&&(p(e)||(n("#usercmd").hasClass("rtl")&&(e=esrever.reverse(e)),O.send("<"+M+">  "+e))),o(""),R=-1,J=""}function g(){!function(){if(void 0!==I){if(M=I.nick,void 0!==I.channels)try{D=JSON.parse(I.channels)}catch(n){}0===D.length&&(D=[B],I.activeChannel=B)}else D=[B],I.activeChannel=B;void 0===M&&a([,k()])}(),E=new LIBRECAST.Context(function(){D.forEach(function(n){d(n)})}),n("#usercmd").keypress(function(n){n.which==x&&(n.preventDefault(),f())}),n("#usercmd").keydown(function(n){switch(n.which){case A:n.preventDefault(),r(R+1);break;case L:n.preventDefault(),r(R-1)}}),n("#usercmd").focus()}function m(n){var e=n.obj;e.send("/sysmsg "+M+" has joined "+e.name)}function k(n){void 0===n&&(n="guest");var e=prompt('Welcome.  Please choose username ("nick") to continue',n);return e=null===e?M:e}function C(e){return n("li:contains("+e+")").attr("id").split("_")[1]}function _(n){n.obj.listen(u)}function w(n){return void 0!==n&&("#"!==(n=n.replace(/^s+|s+$/g,""))[0]&&(n="#"+n),!(n.length<2)&&n.toLowerCase())}function b(e,t){var i;void 0!==(i=n(void 0===t?"div.topic.active":"#topic_"+t))&&i.html("<h1>"+e+"</h1>")}function j(e,t,i){var a=n("<div>").text(e).html(),c=void 0===i||0===i?new Date:new Date(i),s=("0"+(c.getMonth()+1)).slice(-2),o=("0"+c.getDate()).slice(-2),r=("0"+c.getHours()).slice(-2),l=("0"+c.getMinutes()).slice(-2),d=("0"+c.getSeconds()).slice(-2);S('<p><span class="msg">'+('<span class="datestamp">'+c.getFullYear()+"-"+s+"-"+o+"&nbsp;</span>")+('<span class="timestamp">'+r+":"+l+":"+d+"&nbsp;</span>")+a+"</span></p>",t)}function y(e,t){S('<pre><span class="sysmsg">'+n("<div>").text(e).html()+"</span></pre>",t)}function S(e,t){var i;(i=n(void 0===t?"div.socket.active":"#socket_"+t)).hasClass("active")||n("#chansock_"+t).addClass("unread"),void 0!==i&&(i.append(e),i.scrollTop(i.prop("scrollHeight")-i.prop("clientHeight")))}var O,E,x=13,L=40,A=38,N=32,T=["sysmsg"],D=[],H=[],J="",P=[],R=-1,B="#welcome",I=localStorage,M="guest";LIBRECAST.HAS_JQUERY?n(document).ready(function(){g()}):window.onload=function(){g()}}(jQuery,LIBRECAST);
