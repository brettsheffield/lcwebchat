!function(a,u){"use strict";var r,o,t=13,s=40,i=38,c=32,p=1,d=2,f=3,h=5e3,l=["sysmsg"],v=[],m=[],g="",y=[],E=-1,k=localStorage,_="guest";function n(){var e=this;this.channels=[],this.socket=new LIBRECAST.Socket(o,Q);for(var t=[this.socket.defer],n=0;n<arguments.length;n++){var s;try{(s=new LIBRECAST.Channel(o,arguments[n],w)).chatPane=this}catch(e){continue}this.channels.push(s),t.push(s.defer)}var i=this.socket;this.channels.forEach(function(e){a.when(i.defer,e.defer).done(function(){e.bindSocket(i,C),e.interval=setInterval(e.ping.bind(e),h)})}),a.when.apply(a,t).done(function(){e.onReady()})}function L(e){this.nick=e}function T(e){this.nick=_,this.text=e}u.FILTER_KEY="k",u.FILTER_KEY_LONG="key",u.FILTER_NICK="n",u.FILTER_NICK_LONG="nick",u.FILTER_TIME="t",u.FILTER_TIME_LONG="time",u.FILTER_SHORT=[u.FILTER_KEY,u.FILTER_NICK,u.FILTER_TIME],u.FILTER_LONG=[u.FILTER_KEY_LONG,u.FILTER_NICK_LONG,u.FILTER_TIME_LONG],n.prototype.onReady=function(){},L.prototype.seen=function(e){return this.lastSeen=void 0===e?new Date:new Date(e),this},LIBRECAST.Channel.prototype.ping=function(){this.setval("join",_)},LIBRECAST.Channel.prototype.sysmsg=function(e){void 0!==e.html&&this.write(e.html)},LIBRECAST.Channel.prototype.userJoin=function(e){var t=this.id2;return void 0===this.userStatus(e)&&(this.users[e]=new L(e),U(e+" has joined "+this.name,t)),this.users[e].seen(),this},LIBRECAST.Channel.prototype.userPart=function(e){var t=this.id2;void 0===this.userStatus(e)&&(this.users[e]=new L(e),U(e+" has left "+this.name,t)),this.users[e].seen()},LIBRECAST.Channel.prototype.userStatus=function(e,t){return void 0===this.users&&(this.users=[]),void 0===t?this.users[e]:(this.users[e]=new L(e).seen(),this)},LIBRECAST.Channel.prototype.write=function(e){V(e,this.id2)},LIBRECAST.Filter=function(e){this.arg=e;var t=["<",">","="];for(var n in t)for(var s=0;s<e.length;s++)if(e[s]===t[n]){for(var i in this.type=e.substring(0,s),"="===e[s+1]?(this.op=t[n]+"=",this.key=e.substring(s+2)):(this.op=t[n],this.key=e.substring(s+1)),u.FILTER_LONG)this.type===u.FILTER_LONG[i]&&(this.type=u.FILTER_SHORT[i]);if(this.type===u.FILTER_TIME){var a=moment(this.key);a.isValid()&&(this.key=a.format("x")+"000000")}return this}return this.type=u.FILTER_KEY,this.op="=",this.key=e,this},LIBRECAST.Query.prototype.filter=function(e){var t=new LIBRECAST.Filter(e);if(t.type===u.FILTER_KEY)this.key("message_keyword",t.key.toLowerCase().replace(/\W+/g,""));else if(t.type===u.FILTER_NICK)this.key("message_nick",t.key.toLowerCase().replace(/\W+/g,""));else if(t.type===u.FILTER_TIME){var n;for(var s in t.op)"<"===t.op[s]?n|=u.QUERY_LT:">"===t.op[s]?n|=u.QUERY_GT:"="===t.op[s]&&(n|=u.QUERY_EQ);void 0===n&&(n=u.QUERY_EQ),this.timestamp(t.key,n)}else this.filter(e.substring(1));return this},T.prototype.format=function(){return"<"+this.nick+"> "+this.text},T.prototype.parse=function(e){var t=JSON.parse(e);for(var n in t)this[n]=t[n];return this},T.prototype.type=function(e){return void 0===e?this.type:(this.type=e,this)};var C=function(){var e,t=this;for(var n in m)if(m[n].name===t.name){e=m[n].timestamp;break}m[t.id2]=t,k.activeChannel!=t.name&&void 0!==r||N(t.id2),function(e){var t=a("li:contains("+e.name+")"),n=e.id2;if(t.length){var s=t.attr("id").split("_")[1];a("li#chansock_"+s).attr("id","chansock_"+n),a("div#socket_"+s).attr("id","socket_"+n),a("div#topic_"+s).attr("id","topic_"+n)}else{var i=a("div.chat");i.append('<div id="topic_'+n+'" class="topic"></div>'),i.append('<div id="socket_'+n+'" class="socket"></div>'),t=a('<li id="chansock_'+n+'">'+e.name+"</li>"),a("div.channels").append(t),t.on("click",function(){var e=a(this).attr("id").split("_")[1];N(e)})}k.activeChannel==e.name&&N(n)}(t),J(t.name,t.id2),t.getval("topic",A);var s=(new LIBRECAST.Query).timestamp(e,u.QUERY_GT);t.getmsg(j,s)},w=function(e){var t=e.obj;t.join(Y),-1===v.indexOf(t.name)&&(v.push(t.name),k.channels=JSON.stringify(v))};function I(e){var t=e[1];return void 0===t&&(t=K(_)),r&&_&&r.send("/sysmsg "+_+" is now known as "+t),_=t,void 0!==k&&(k.nick=_),!0}function R(e){var t=M(e[1]);return U('changing channels to "'+t+'"'),-1===v.indexOf(t)?(!function(e){if(!e)return U("'"+e+"' not a valid channel name");e=M(e),o.chatPanes.push(new n(e))}(t),k.activeChannel=t):N(P(t)),!0}function S(e){var t;if(void 0!==e[1]){if(!(t=M(e[1])))return!0}else t=r.name;return U('parting channel "'+t+'"'),-1===v.indexOf(t)||function(e){var t=P(e),n=m[t],s=(new T).type(d);n.send(JSON.stringify(s)),function(e){for(var t=0,n=v.length;t<n;t++)if(v[t]===e.toLowerCase()){v.splice(v.indexOf(t)),k.channels=JSON.stringify(v);break}}(e),k.activeChannel===e&&N(P(v[0]));a("#socket_"+t).remove(),a("#chansock_"+t).remove()}(t),!0}function b(){return a("#usercmd").val()}function O(e){a("#usercmd").val(e)}function F(e){if(e>y.length)e=y.length;else{if(e<0)return O(g),void(E=-1);0==e&&-1==E&&(g=b())}void 0!==y[e]&&(O(y[e]),E=e)}function N(e){var t=a("div.chat");t.find("div.topic").removeClass("active"),t.find("div.socket").removeClass("active"),a("div.channels > li.active").removeClass("active"),a("#topic_"+e).addClass("active"),a("#socket_"+e).addClass("active"),a("#chansock_"+e).addClass("active").removeClass("unread"),r=m[e];var n=a("#chansock_"+e).text();n&&(k.activeChannel=n),window.history.pushState(n,n,"/"+n.substring(1))}function x(e,t,n,s,i,a,r,o){var c,h=e.obj,l=m[h.id];if(l.timestamp=o,t===u.OP_SOCKET_MSG){if(!B(r,!0)){try{c=(new T).parse(r)}catch(e){return!1}switch(c.type){case f:l.sysmsg(c);break;case p:l.userJoin(c.nick);break;case d:l.userPart(c.nick);break;default:H(c,h.id,o)}}}else t===u.OP_CHANNEL_GETVAL?"topic"===a&&J(r,h.id):t===u.OP_CHANNEL_SETVAL&&("join"==a?l.userJoin(r):"topic"==a&&(J(r,h.id),U('channel topic changed to "'+r+'"')))}function j(e,t,n,s,i,a,r,o){var c,h=e.obj.id2;void 0===j.count&&(j.count=0);try{c=(new T).parse(r)}catch(e){return!1}void 0!==c.text&&H(c,h,o)}function A(e,t,n,s,i,a,r,o){J(r,e.obj.id2)}function B(e,t){if("/"!=e.substring(0,1))return!1;var n,s=e.split(" "),i=s[0].substring(1);switch(r&&!t&&0<=l.indexOf(i)&&r.send(e),t&&l.indexOf(i),i){case"?":return function(e){e.shift();for(var t=new LIBRECAST.Query;0<e.length;)t.filter(e.shift());return r.getmsg(j,t),!0}(s);case"help":return U("/help"),U("  commands: "),U("  /help                       - displays this help message"),U("  /nick nickname              - changes your channel nick"),U("  /topic channel topic        - set channel topic"),U("  /join channel               - join channel"),U("  /part [channel]             - leave active or specified channel"),U("  /reset                      - delete all local storage"),U("  /rtl                        - toggle right-to-left input"),U("  /who                        - list when users were last seen on channel"),U("  /upload                     - upload a file"),U("  /?                          - search messages eg:-"),U("  /? hello                    - search for messages containing the word 'hello'"),U("  /? time>2017-12-08          - search for messages after 2017-12-08"),U("  /? t<2017-12-08             - search for messages before 2017-12-08"),U("  /? nick=fred                - search for messages where nick='fred'"),U("  /? n=fred hello t<2017-12-08T12:00"),U("                              - messages by fred containing 'hello' before noon on 8th December 2017"),U(""),!0;case"join":return R(s);case"nick":return I(s);case"part":return S(s);case"reset":localStorage.clear();break;case"rtl":return a("#usercmd").toggleClass("rtl"),!0;case"sysmsg":return(n=s).shift(),U(n.join(" ")),!0;case"topic":return function(e,t){e.shift();var n=e.join(" ");return r&&r.setval("topic",n),!0}(s);case"upload":return a('input[name="filename"]').trigger("click"),!0;case"who":return function(){for(var e in U("Users on channel "+r.name+":"),r.users){var t=r.users[e];U(" "+t.nick+" (seen: "+t.lastSeen+")")}return!0}()}return!0}function G(){var e,t=b();if(e=t,y.unshift(e),y.length>c&&y.pop(),!B(t)&&r){a("#usercmd").hasClass("rtl")&&(t=esrever.reverse(t));var n=new T(t);r.send(JSON.stringify(n))}O(""),E=-1,g=""}function e(){!function(){if(void 0!==k&&(_=k.nick,void 0!==k.channels))try{v=JSON.parse(k.channels)}catch(e){}void 0===_&&I([,K()]);var e=window.location.pathname.substring(1);(e=M(e))&&(v.push(e),k.activeChannel=e)}(),o=new LIBRECAST.Context(function(){var t;(t=this).chatPanes=[],o.chatPanes.push(new n),v.forEach(function(e){t.chatPanes.push(new n(e))})}),function(){a("#usercmd").keypress(function(e){e.which==t&&(e.preventDefault(),G())}),a("#usercmd").keydown(function(e){switch(e.which){case i:e.preventDefault(),F(E+1);break;case s:e.preventDefault(),F(E-1)}});var n=a('div.uploader > form > input[name="filename"]');n.change(function(){var i=n[0].value,e=i.split("\\");if(1<e.length&&(i=e[e.length-1]),0<n.length){var t=a('<progress class="upload"></progress>');t.val(0),t.prop("max",100),V(t),a.ajax({url:"/upload/",type:"POST",data:new FormData(a("form")[0]),cache:!1,contentType:!1,processData:!1,xhr:function(){var e=a.ajaxSettings.xhr();return e.upload&&(e.upload.addEventListener("error",function(e){U("error uploading file")}),e.upload.addEventListener("load",function(e){U('"'+i+'" uploaded ('+e.loaded+" bytes)")}),e.upload.addEventListener("progress",function(e){t.prop("max",e.total),t.val(e.loaded)})),e},success:function(e){var t=a(e).find("sha1sum").text(),n="/files/"+t,s=new T;s.type=f,s.html='<pre><span class="sysmsg">'+_+' has uploaded a file <a href="'+n+'" download>'+i+"</a></span></pre>",r.send(JSON.stringify(s))}})}})}(),a("#usercmd").focus()}function Y(e){e.obj.setval("join",_)}function K(e){void 0===e&&(e="guest");var t=prompt('Welcome.  Please choose username ("nick") to continue',e);return t=null===t?_:t}function P(e){return a("li:contains("+e+")").attr("id").split("_")[1]}function Q(e){e.obj.listen(x)}function D(e){var t=e?new Date(Number(e.toString().substring(0,13))):new Date,n=("0"+(t.getMonth()+1)).slice(-2),s=("0"+t.getDate()).slice(-2),i=("0"+t.getHours()).slice(-2),a=("0"+t.getMinutes()).slice(-2),r=("0"+t.getSeconds()).slice(-2);return'<span class="nanostamp">'+(e?e.toString():"")+"</span>"+('<span class="datestamp">'+t.getFullYear()+"-"+n+"-"+s+"&nbsp;</span>")+('<span class="timestamp">'+i+":"+a+":"+r+"&nbsp;</span>")}function J(e,t){var n;void 0!==(n=a(void 0===t?"div.topic.active":"#topic_"+t))&&n.html("<h1>"+e+"</h1>")}function M(e){return void 0!==e&&("#"!==(e=e.replace(/^s+|s+$/g,""))[0]&&(e="#"+e),!(e.length<2)&&e.toLowerCase())}function H(e,t,n){var s,i=m[t];if("object"==typeof e){if(void 0===e.text)return e.type===p?U(e.nick+" has joined "+i.name,t,n):e.type===d&&U(e.nick+" has left "+i.name,t,n),!1;s=a("<div>").text(e.format()).html()}else s=a("<div>").text(e).html();V('<p><span class="msg">'+D(n)+s+"</span></p>",t)}function U(e,t,n){var s=a("<div>").text(e).html();V('<pre><span class="sysmsg">'+D(n)+s+"</span></pre>",t)}function V(e,t){var n;(n=a(void 0===t?"div.socket.active":"#socket_"+t)).hasClass("active")||a("#chansock_"+t).addClass("unread"),void 0!==n&&(n.append(e),n.scrollTop(n.prop("scrollHeight")-n.prop("clientHeight")))}LIBRECAST.HAS_JQUERY?a(document).ready(function(){e()}):window.onload=function(){e()}}(jQuery,LIBRECAST);
