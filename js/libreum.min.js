!function(e,n){"use strict";function o(){if(console.log("init()"),void 0!==B){if(void 0!==B.nick&&(G=B.nick),void 0!==B.channels)try{N=JSON.parse(B.channels)}catch(e){console.log("no channels loaded")}if(0===N.length&&(N=[J],B.activeChannel=J),void 0===B.nick){var n=prompt('Welcome.  Please choose username ("nick") to continue',"guest");C([,n=null===n?G:n])}console.log(N)}else N=[J],B.activeChannel=J;O=new LIBRECAST.Librecast(s),e("#usercmd").keypress(function(n){n.which==L&&(n.preventDefault(),function(){var n=t();(function(e){console.log("cmdHistorySet("+e+")"),P.unshift(e),P.length>H&&P.pop()})(n),S&&(y(n)||(e("#usercmd").hasClass("rtl")&&(n=esrever.reverse(n)),console.log("sending "+n),S.send("<"+G+">  "+n)));c(""),R=-1,T=""}())}),e("#usercmd").keydown(function(e){switch(e.which){case x:console.log("UP"),e.preventDefault(),i(R+1);break;case E:console.log("DOWN"),e.preventDefault(),i(R-1)}}),e("#usercmd").focus()}function t(){return e("#usercmd").val()}function c(n){e("#usercmd").val(n)}function i(e){if(console.log("cmdHistoryGet("+e+")"),e>P.length)e=P.length;else{if(e<0)return console.log("restoring current command"),c(T),void(R=-1);0==e&&-1==R&&(console.log("stashing command history"),T=t())}void 0!==P[e]&&(console.log("getting cmdHistory"),c(P[e]),R=e)}function s(){console.log("librecastCtxReady()"),N.forEach(function(e){console.log(e),u(e)})}function a(n){var o=e("div.chat");o.find("div.topic").removeClass("active"),o.find("div.socket").removeClass("active"),e("div.channels > li.active").removeClass("active"),e("#topic_"+n).addClass("active"),e("#socket_"+n).addClass("active"),e("#chansock_"+n).addClass("active").removeClass("unread"),S=D[n];var t=e("#chansock_"+n).text();t&&(B.activeChannel=t)}function l(n){console.log("partChannel("+n+")");var o=r(n);!function(e){for(var n=0,o=N.length;n<o;n++)if(N[n]===e.toLowerCase()){delete N[n],B.channels=JSON.stringify(N);break}}(n),B.activeChannel===n&&a(r(N[0])),e("#socket_"+o).remove(),e("#chansock_"+o).remove()}function r(n){return e("li:contains("+n+")").attr("id").split("_")[1]}function d(e){return void 0!==e&&("#"!==(e=e.replace(/^s+|s+$/g,""))[0]&&(e="#"+e),!(e.length<2)&&e.toLowerCase())}function u(o){if(!o)return w("'"+o+"' not a valid channel name"),!1;o=d(o);var t=[],c=new n.LibrecastSocket(O,g),i=new n.LibrecastChannel(O,o,v);t.push(c.defer),t.push(i.defer),e.when.apply(e,t).done(function(){console.log("socket and channel both ready ("+i.name+")"),console.log("socket id="+c.id),console.log("channel id="+i.id),i.bind(c,p)})}function v(e){var n=e.obj;console.log("channel "+n.name+" is ready"),n.join(f),-1===N.indexOf(n.name)&&(N.push(n.name),B.channels=JSON.stringify(N))}function h(e,n,o,t,c,i){_(i,e.obj.id)}function g(e){console.log("my socket is ready");e.obj.listen(m)}function p(n){var o=n.obj;D[o.id2]=o,B.activeChannel!=o.name&&void 0!==S||a(o.id2),console.log("channel "+o.name+" bound to socket "+o.id2),function(n){var o=e("li:contains("+n.name+")"),t=n.id2;if(o.length){var c=o.attr("id").split("_")[1];e("li#chansock_"+c).attr("id","chansock_"+t),e("div#socket_"+c).attr("id","socket_"+t),e("div#topic_"+c).attr("id","topic_"+t)}else{var i=e("div.chat");i.append('<div id="topic_'+t+'" class="topic"></div>'),i.append('<div id="socket_'+t+'" class="socket"></div>'),o=e('<li id="chansock_'+t+'">'+n.name+"</li>"),e("div.channels").append(o),o.on("click",function(){a(e(this).attr("id").split("_")[1])})}B.activeChannel==n.name&&a(t)}(o),_(o.name,o.id2),o.getval("topic",h),o.getmsg(k)}function f(e){var n=e.obj;console.log("channel "+n.name+" joined"),n.send("/sysmsg "+G+" has joined "+n.name)}function m(e,o,t,c,i,s,a,l){console.log("gotmail()");var r=e.obj.id;o===n.OP_SOCKET_MSG?y(a,!0)||b(a,r,l):o===n.OP_CHANNEL_GETVAL?_(a,r):o===n.OP_CHANNEL_SETVAL&&("topic"==s?_(a,r):console.log("ignoring unknown key '"+s+"'"))}function k(e,n,o,t,c,i,s,a){var l=e.obj.id2;void 0===k.count&&(k.count=0),console.log("socket "+t+": got a message result "+ ++k.count),console.log(s),"/"!=s.substring(0,1)&&"topic"!==s&&b(s,l,a)}function C(e){var n=e[1];return S&&G&&S.send("/sysmsg "+G+" is now known as "+n),G=n,void 0!==B&&(B.nick=G),!0}function _(n,o){var t;void 0!==(t=e(void 0===o?"div.topic.active":"#topic_"+o))&&t.html("<h1>"+n+"</h1>")}function y(n,o){if("/"!=n.substring(0,1))return!1;var t=n.split(" "),c=t[0].substring(1);switch(S&&!o&&A.indexOf(c)>=0&&S.send(n),o&&A.indexOf(c)<0&&console.log("bad remote command received: "+c),c){case"help":return w("/help"),w("  commands: "),w("  /help                       - displays this help message"),w("  /nick nickname              - changes your channel nick"),w("  /topic channel topic        - set channel topic"),w("  /join channel               - join channel"),w("  /part [channel]             - leave active or specified channel"),w("  /reset                      - delete all local storage"),w("  /rtl                        - toggle right-to-left input"),w(""),!0;case"join":return function(e){var n=d(e[1]);return w('changing channels to "'+n+'"'),console.log(N),-1===N.indexOf(n)?(u(n),B.activeChannel=n):(console.log("already joined to channel '"+n+"'"),a(r(n))),!0}(t);case"nick":return C(t);case"part":return function(e){var n;if(void 0!==e[1]){if(!(n=d(e[1])))return console.log("invalid channel name"),!0}else n=S.name;return w('parting channel "'+n+'"'),-1===N.indexOf(n)?(console.log("invalid channel name"),!0):(l(n),!0)}(t);case"reset":localStorage.clear(),console.log("local storage wiped");break;case"rtl":return e("#usercmd").toggleClass("rtl"),!0;case"sysmsg":return function(e){return e.shift(),w(e.join(" ")),!0}(t);case"topic":return function(e,n){e.shift();var o=e.join(" ");return w('channel topic changed to "'+o+'"'),S&&S.setval("topic",o),!0}(t)}return!0}function b(n,o,t){var c=e("<div>").text(n).html(),i=void 0===t||0===t?new Date:new Date(t),s=("0"+(i.getMonth()+1)).slice(-2),a=("0"+i.getDate()).slice(-2),l=("0"+i.getHours()).slice(-2),r=("0"+i.getMinutes()).slice(-2),d=("0"+i.getSeconds()).slice(-2);j('<p><span class="msg">'+('<span class="datestamp">'+i.getFullYear()+"-"+s+"-"+a+"&nbsp;</span>")+('<span class="timestamp">'+l+":"+r+":"+d+"&nbsp;</span>")+c+"</span></p>",o)}function w(n,o){j('<pre><span class="sysmsg">'+e("<div>").text(n).html()+"</span></pre>",o)}function j(n,o){var t;(t=e(void 0===o?"div.socket.active":"#socket_"+o)).hasClass("active")||e("#chansock_"+o).addClass("unread"),void 0!==t&&(t.append(n),t.scrollTop(t.prop("scrollHeight")-t.prop("clientHeight")))}var S,O,L=13,E=40,x=38,H=32,A=["sysmsg"],N=[],D=[],T="",P=[],R=-1,J="#welcome",B=localStorage,G="guest";LIBRECAST.HAS_JQUERY?e(document).ready(function(){console.log("document loaded (jQuery)"),o()}):window.onload=function(){console.log("document loaded"),o()}}(jQuery,LIBRECAST);
