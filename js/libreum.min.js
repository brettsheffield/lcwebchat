!function(e,n){"use strict";function t(){var n=this;this.channels=[],this.socket=new LIBRECAST.Socket(O,w);for(var t=[this.socket.defer],i=0;i<arguments.length;i++){var s;try{(s=new LIBRECAST.Channel(O,arguments[i],F)).chatPane=this}catch(e){continue}this.channels.push(s),t.push(s.defer)}var a=this.socket;this.channels.forEach(function(n){e.when(a.defer,n.defer).done(function(){n.bindSocket(a,V),n.interval=setInterval(n.ping.bind(n),J)})}),e.when.apply(e,t).done(function(){n.onReady()})}function i(e){this.nick=e}function s(e){this.nick=Y,this.text=e}function a(e){var n=e[1];return void 0===n&&(n=y(Y)),A&&Y&&A.send("/sysmsg "+Y+" is now known as "+n),Y=n,void 0!==W&&(W.nick=Y),!0}function r(e){var n=b(e[1]);return L('changing channels to "'+n+'"'),-1===D.indexOf(n)?(!function(e){if(!e)return L("'"+e+"' not a valid channel name"),!1;e=b(e),O.chatPanes.push(new t(e))}(n),W.activeChannel=n):l(C(n)),!0}function c(n){var t;if(void 0!==n[1]){if(!(t=b(n[1])))return!0}else t=A.name;return L('parting channel "'+t+'"'),-1===D.indexOf(t)||(function(n){var t=C(n),i=H[t],a=(new s).type(N);i.send(JSON.stringify(a)),function(e){for(var n=0,t=D.length;n<t;n++)if(D[n]===e.toLowerCase()){D.splice(D.indexOf(n)),W.channels=JSON.stringify(D);break}}(n),W.activeChannel===n&&l(C(D[0]));e("#socket_"+t).remove(),e("#chansock_"+t).remove()}(t),!0)}function o(){return e("#usercmd").val()}function u(n){e("#usercmd").val(n)}function h(e){if(e>G.length)e=G.length;else{if(e<0)return u(Q),void(M=-1);0==e&&-1==M&&(Q=o())}void 0!==G[e]&&(u(G[e]),M=e)}function l(n){var t=e("div.chat");t.find("div.topic").removeClass("active"),t.find("div.socket").removeClass("active"),e("div.channels > li.active").removeClass("active"),e("#topic_"+n).addClass("active"),e("#socket_"+n).addClass("active"),e("#chansock_"+n).addClass("active").removeClass("unread"),A=H[n];var i=e("#chansock_"+n).text();i&&(W.activeChannel=i)}function d(e,t,i,a,r,c,o,u){var h,l=e.obj,d=H[l.id];if(d.timestamp=u,t===n.OP_SOCKET_MSG){if(!p(o,!0)){try{h=(new s).parse(o)}catch(e){return!1}switch(h.type){case B:d.userJoin(h.nick);break;case N:d.userPart(h.nick);break;default:E(h,l.id,u)}}}else t===n.OP_CHANNEL_GETVAL?"topic"===c&&_(o,l.id):t===n.OP_CHANNEL_SETVAL&&("join"==c?d.userJoin(o):"topic"==c&&(_(o,l.id),L('channel topic changed to "'+o+'"')))}function f(e,n,t,i,a,r,c,o){var u=e.obj.id2;void 0===f.count&&(f.count=0);var h;try{h=(new s).parse(c)}catch(e){return!1}void 0!==h.text&&E(h,u,o)}function v(e,n,t,i,s,a,r,c){_(r,e.obj.id2)}function p(n,t){if("/"!=n.substring(0,1))return!1;var i=n.split(" "),s=i[0].substring(1);switch(A&&!t&&P.indexOf(s)>=0&&A.send(n),t&&P.indexOf(s),s){case"?":return function(e){e.shift();for(var n=new LIBRECAST.Query;e.length>0;)n.filter(e.shift());return A.getmsg(f,n),!0}(i);case"help":return L("/help"),L("  commands: "),L("  /help                       - displays this help message"),L("  /nick nickname              - changes your channel nick"),L("  /topic channel topic        - set channel topic"),L("  /join channel               - join channel"),L("  /part [channel]             - leave active or specified channel"),L("  /reset                      - delete all local storage"),L("  /rtl                        - toggle right-to-left input"),L("  /who                        - list when users were last seen on channel"),L(""),!0;case"join":return r(i);case"nick":return a(i);case"part":return c(i);case"reset":localStorage.clear();break;case"rtl":return e("#usercmd").toggleClass("rtl"),!0;case"sysmsg":return function(e){return e.shift(),L(e.join(" ")),!0}(i);case"topic":return function(e,n){e.shift();var t=e.join(" ");return A&&A.setval("topic",t),!0}(i);case"who":return function(){L("Users on channel "+A.name+":");for(var e in A.users){var n=A.users[e];L(" "+n.nick+" (seen: "+n.lastSeen+")")}return!0}()}return!0}function m(){var n=o();if(function(e){G.unshift(e),G.length>I&&G.pop()}(n),A&&!p(n)){e("#usercmd").hasClass("rtl")&&(n=esrever.reverse(n));var t=new s(n);A.send(JSON.stringify(t))}u(""),M=-1,Q=""}function g(){!function(){if(void 0!==W){if(Y=W.nick,void 0!==W.channels)try{D=JSON.parse(W.channels)}catch(e){}0===D.length&&(D=[U],W.activeChannel=U)}else D=[U],W.activeChannel=U;void 0===Y&&a([,y()])}(),O=new LIBRECAST.Context(function(){!function(e){e.chatPanes=[],D.forEach(function(n){e.chatPanes.push(new t(n))})}(this)}),e("#usercmd").keypress(function(e){e.which==T&&(e.preventDefault(),m())}),e("#usercmd").keydown(function(e){switch(e.which){case R:e.preventDefault(),h(M+1);break;case x:e.preventDefault(),h(M-1)}}),e("#usercmd").focus()}function k(e){e.obj.setval("join",Y)}function y(e){void 0===e&&(e="guest");var n=prompt('Welcome.  Please choose username ("nick") to continue',e);return n=null===n?Y:n}function C(n){return e("li:contains("+n+")").attr("id").split("_")[1]}function w(e){e.obj.listen(d)}function S(e){var n=e?new Date(Number(e.toString().substring(0,13))):new Date,t=("0"+(n.getMonth()+1)).slice(-2),i=("0"+n.getDate()).slice(-2),s=("0"+n.getHours()).slice(-2),a=("0"+n.getMinutes()).slice(-2),r=("0"+n.getSeconds()).slice(-2);return'<span class="nanostamp">'+(e?e.toString():"")+"</span>"+('<span class="datestamp">'+n.getFullYear()+"-"+t+"-"+i+"&nbsp;</span>")+('<span class="timestamp">'+s+":"+a+":"+r+"&nbsp;</span>")}function _(n,t){var i;void 0!==(i=e(void 0===t?"div.topic.active":"#topic_"+t))&&i.html("<h1>"+n+"</h1>")}function b(e){return void 0!==e&&("#"!==(e=e.replace(/^s+|s+$/g,""))[0]&&(e="#"+e),!(e.length<2)&&e.toLowerCase())}function E(n,t,i){var s,a=H[t];if("object"==typeof n){if(void 0===n.text)return n.type===B?L(n.nick+" has joined "+a.name,t,i):n.type===N&&L(n.nick+" has left "+a.name,t,i),!1;s=e("<div>").text(n.format()).html()}else s=e("<div>").text(n).html();j('<p><span class="msg">'+S(i)+s+"</span></p>",t)}function L(n,t,i){var s=e("<div>").text(n).html();j('<pre><span class="sysmsg">'+S(i)+s+"</span></pre>",t)}function j(n,t){var i;(i=e(void 0===t?"div.socket.active":"#socket_"+t)).hasClass("active")||e("#chansock_"+t).addClass("unread"),void 0!==i&&(i.append(n),i.scrollTop(i.prop("scrollHeight")-i.prop("clientHeight")))}var A,O,T=13,x=40,R=38,I=32,B=1,N=2,J=5e3,P=["sysmsg"],D=[],H=[],Q="",G=[],M=-1,U="#welcome",W=localStorage,Y="guest";t.prototype.onReady=function(){},i.prototype.seen=function(e){return this.lastSeen=void 0===e?new Date:new Date(e),this},LIBRECAST.Channel.prototype.ping=function(){this.setval("join",Y)},LIBRECAST.Channel.prototype.userJoin=function(e){var n=this.id2;return void 0===this.userStatus(e)&&(this.users[e]=new i(e),L(e+" has joined "+this.name,n)),this.users[e].seen(),this},LIBRECAST.Channel.prototype.userPart=function(e){var n=this.id2;void 0===this.userStatus(e)&&(this.users[e]=new i(e),L(e+" has left "+this.name,n)),this.users[e].seen()},LIBRECAST.Channel.prototype.userStatus=function(e,n){return void 0===this.users&&(this.users=[]),void 0===n?this.users[e]:(this.users[e]=new i(e).seen(),this)},LIBRECAST.Query.prototype.filter=function(e){var n=e.indexOf("=");if(-1===n)this.key("message_keyword",e.toLowerCase().replace(/\W+/g,""));else if(n>0){var t=e.substring(0,n),i=e.substring(n+1);"n"!==t&&"nick"!==t||this.key("message_nick",i.toLowerCase().replace(/\W+/g,""))}else this.filter(e.substring(1));return this},s.prototype.format=function(){return"<"+this.nick+"> "+this.text},s.prototype.parse=function(e){var n=JSON.parse(e);for(var t in n)this[t]=n[t];return this},s.prototype.type=function(e){return void 0===e?this.type:(this.type=e,this)};var V=function(){var t;for(var i in H)if(H[i].name===this.name){t=H[i].timestamp;break}H[this.id2]=this,W.activeChannel!=this.name&&void 0!==A||l(this.id2),function(n){var t=e("li:contains("+n.name+")"),i=n.id2;if(t.length){var s=t.attr("id").split("_")[1];e("li#chansock_"+s).attr("id","chansock_"+i),e("div#socket_"+s).attr("id","socket_"+i),e("div#topic_"+s).attr("id","topic_"+i)}else{var a=e("div.chat");a.append('<div id="topic_'+i+'" class="topic"></div>'),a.append('<div id="socket_'+i+'" class="socket"></div>'),t=e('<li id="chansock_'+i+'">'+n.name+"</li>"),e("div.channels").append(t),t.on("click",function(){l(e(this).attr("id").split("_")[1])})}W.activeChannel==n.name&&l(i)}(this),_(this.name,this.id2),this.getval("topic",v);var s=(new LIBRECAST.Query).timestamp(t,n.QUERY_GT);this.getmsg(f,s)},F=function(e){var n=e.obj;n.join(k),-1===D.indexOf(n.name)&&(D.push(n.name),W.channels=JSON.stringify(D))};LIBRECAST.HAS_JQUERY?e(document).ready(function(){g()}):window.onload=function(){g()}}(jQuery,LIBRECAST);
