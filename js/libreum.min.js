!function(e,n){"use strict";function o(){if(console.log("init()"),"undefined"!=typeof localStorage){if(void 0!==localStorage.nick&&(B=localStorage.nick),void 0!==localStorage.channels)try{N=JSON.parse(localStorage.channels)}catch(e){console.log("no channels loaded")}if(0===N.length&&(N=[J],localStorage.activeChannel=J),void 0===localStorage.nick){var n=prompt('Welcome.  Please choose username ("nick") to continue',"guest");S([,n=null===n?B:n])}console.log(N)}O=new LIBRECAST.Librecast(i),e("#usercmd").keypress(function(n){n.which==L&&(n.preventDefault(),function(){var n=t();(function(e){console.log("cmdHistorySet("+e+")"),P.unshift(e),P.length>H&&P.pop()})(n),j&&(C(n)||(e("#usercmd").hasClass("rtl")&&(n=esrever.reverse(n)),console.log("sending "+n),j.send("<"+B+">  "+n)));c(""),R=-1,T=""}())}),e("#usercmd").keydown(function(e){switch(e.which){case x:console.log("UP"),e.preventDefault(),a(R+1);break;case E:console.log("DOWN"),e.preventDefault(),a(R-1)}}),e("#usercmd").focus()}function t(){return e("#usercmd").val()}function c(n){e("#usercmd").val(n)}function a(e){if(console.log("cmdHistoryGet("+e+")"),e>P.length)e=P.length;else{if(e<0)return console.log("restoring current command"),c(T),void(R=-1);0==e&&-1==R&&(console.log("stashing command history"),T=t())}void 0!==P[e]&&(console.log("getting cmdHistory"),c(P[e]),R=e)}function i(){console.log("librecastCtxReady()"),N.forEach(function(e){console.log(e),g(e)})}function s(n){var o=e("div.chat");o.find("div.topic").removeClass("active"),o.find("div.socket").removeClass("active"),e("div.channels > li.active").removeClass("active"),e("#topic_"+n).addClass("active"),e("#socket_"+n).addClass("active"),e("#chansock_"+n).addClass("active").removeClass("unread"),j=D[n];var t=e("#chansock_"+n).text();t&&(localStorage.activeChannel=t)}function l(n){console.log("partChannel("+n+")");var o=r(n);!function(e){for(var n=0,o=N.length;n<o;n++)if(N[n]===e.toLowerCase()){delete N[n],localStorage.channels=JSON.stringify(N);break}}(n),localStorage.activeChannel===n&&s(r(N[0])),e("#socket_"+o).remove(),e("#chansock_"+o).remove()}function r(n){return e("li:contains("+n+")").attr("id").split("_")[1]}function d(e){return void 0!==e&&("#"!==(e=e.replace(/^s+|s+$/g,""))[0]&&(e="#"+e),!(e.length<2)&&e.toLowerCase())}function g(o){if(!o)return b("'"+o+"' not a valid channel name"),!1;o=d(o);var t=[],c=new n.LibrecastSocket(O,h),a=new n.LibrecastChannel(O,o,u);t.push(c.defer),t.push(a.defer),e.when.apply(e,t).done(function(){console.log("socket and channel both ready ("+a.name+")"),console.log("socket id="+c.id),console.log("channel id="+a.id),a.bind(c,p)})}function u(e){var n=e.obj;console.log("channel "+n.name+" is ready"),n.join(f),-1===N.indexOf(n.name)&&(N.push(n.name),localStorage.channels=JSON.stringify(N))}function v(e,n,o,t,c,a){y(a,e.obj.id)}function h(e){console.log("my socket is ready");e.obj.listen(m)}function p(n){var o=n.obj;D[o.id2]=o,localStorage.activeChannel!=o.name&&void 0!==j||s(o.id2),console.log("channel "+o.name+" bound to socket "+o.id2),function(n){var o=e("li:contains("+n.name+")"),t=n.id2;if(o.length){var c=o.attr("id").split("_")[1];e("li#chansock_"+c).attr("id","chansock_"+t),e("div#socket_"+c).attr("id","socket_"+t),e("div#topic_"+c).attr("id","topic_"+t)}else{var a=e("div.chat");a.append('<div id="topic_'+t+'" class="topic"></div>'),a.append('<div id="socket_'+t+'" class="socket"></div>'),o=e('<li id="chansock_'+t+'">'+n.name+"</li>"),e("div.channels").append(o),o.on("click",function(){s(e(this).attr("id").split("_")[1])})}localStorage.activeChannel==n.name&&s(t)}(o),y(o.name,o.id2),o.getval("topic",v),o.getmsg(k)}function f(e){var n=e.obj;console.log("channel "+n.name+" joined"),n.send("/sysmsg "+B+" has joined "+n.name)}function m(e,o,t,c,a,i,s,l){console.log("gotmail()");var r=e.obj.id;o===n.OP_SOCKET_MSG?C(s,!0)||_(s,r,l):o===n.OP_CHANNEL_GETVAL?y(s,r):o===n.OP_CHANNEL_SETVAL&&("topic"==i?y(s,r):console.log("ignoring unknown key '"+i+"'"))}function k(e,n,o,t,c,a,i,s){var l=e.obj.id2;void 0===k.count&&(k.count=0),console.log("socket "+t+": got a message result "+ ++k.count),console.log(i),"/"!=i.substring(0,1)&&"topic"!==i&&_(i,l,s)}function S(e){var n=e[1];return j&&B&&j.send("/sysmsg "+B+" is now known as "+n),B=n,"undefined"!=typeof localStorage&&(localStorage.nick=B),!0}function y(n,o){var t;void 0!==(t=e(void 0===o?"div.topic.active":"#topic_"+o))&&t.html("<h1>"+n+"</h1>")}function C(n,o){if("/"!=n.substring(0,1))return!1;var t=n.split(" "),c=t[0].substring(1);switch(j&&!o&&A.indexOf(c)>=0&&j.send(n),o&&A.indexOf(c)<0&&console.log("bad remote command received: "+c),c){case"help":return b("/help"),b("  commands: "),b("  /help                       - displays this help message"),b("  /nick nickname              - changes your channel nick"),b("  /topic channel topic        - set channel topic"),b("  /join channel               - join channel"),b("  /part [channel]             - leave active or specified channel"),b("  /reset                      - delete all local storage"),b("  /rtl                        - toggle right-to-left input"),b(""),!0;case"join":return function(e){var n=d(e[1]);return b('changing channels to "'+n+'"'),console.log(N),-1===N.indexOf(n)?(g(n),localStorage.activeChannel=n):(console.log("already joined to channel '"+n+"'"),s(r(n))),!0}(t);case"nick":return S(t);case"part":return function(e){var n;if(void 0!==e[1]){if(!(n=d(e[1])))return console.log("invalid channel name"),!0}else n=j.name;return b('parting channel "'+n+'"'),-1===N.indexOf(n)?(console.log("invalid channel name"),!0):(l(n),!0)}(t);case"reset":localStorage.clear(),console.log("local storage wiped");break;case"rtl":return e("#usercmd").toggleClass("rtl"),!0;case"sysmsg":return function(e){return e.shift(),b(e.join(" ")),!0}(t);case"topic":return function(e,n){e.shift();var o=e.join(" ");return b('channel topic changed to "'+o+'"'),j&&j.setval("topic",o),!0}(t)}return!0}function _(n,o,t){var c=e("<div>").text(n).html(),a=void 0===t||0===t?new Date:new Date(t),i=("0"+(a.getMonth()+1)).slice(-2),s=("0"+a.getDate()).slice(-2),l=("0"+a.getHours()).slice(-2),r=("0"+a.getMinutes()).slice(-2),d=("0"+a.getSeconds()).slice(-2);w('<p><span class="msg">'+('<span class="datestamp">'+a.getFullYear()+"-"+i+"-"+s+"&nbsp;</span>")+('<span class="timestamp">'+l+":"+r+":"+d+"&nbsp;</span>")+c+"</span></p>",o)}function b(n,o){w('<pre><span class="sysmsg">'+e("<div>").text(n).html()+"</span></pre>",o)}function w(n,o){var t;(t=e(void 0===o?"div.socket.active":"#socket_"+o)).hasClass("active")||e("#chansock_"+o).addClass("unread"),void 0!==t&&(t.append(n),t.scrollTop(t.prop("scrollHeight")-t.prop("clientHeight")))}var j,O,L=13,E=40,x=38,H=32,A=["sysmsg"],N=[],D=[],T="",P=[],R=-1,J="#welcome",B="guest";LIBRECAST.HAS_JQUERY?e(document).ready(function(){console.log("document loaded (jQuery)"),o()}):window.onload=function(){console.log("document loaded"),o()}}(jQuery,LIBRECAST);
